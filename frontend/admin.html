<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¢–æ–≤–∞—Ä–∞–º–∏ - Pizza Inventory</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    
    <style>
        .product-form-hint {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .product-form-hint::before {
            content: 'üí° ';
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-products">0</div>
                <div class="stat-label">–í—Å—å–æ–≥–æ —Ç–æ–≤–∞—Ä—ñ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-pieces">0</div>
                <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å (—à—Ç)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-boxes">0</div>
                <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å (—è—â)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="low-stock">0</div>
                <div class="stat-label">–ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                ‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–≤–∞—Ä
            </div>
            <div class="card-body">
                <div class="product-form-hint">
                    –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ—Å–Ω–æ–≤–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–æ–≤–∞—Ä. –ü–æ–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω—ñ * —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º–∏.
                </div>
                
                <form id="product-form">
                    <div class="required-fields-note">–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è</div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name" class="required">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="name" name="name" required placeholder="–ü—ñ—Ü–∞ –ú–∞—Ä–≥–∞—Ä–∏—Ç–∞">
                        </div>
                        <div class="form-group">
                            <label for="code" class="required">–ö–æ–¥ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="code" name="code" required placeholder="PM001">
                        </div>
                        <div class="form-group">
                            <label for="weight" class="required">–í–∞–≥–∞ (–≥)</label>
                            <input type="number" id="weight" name="weight" step="0.1" required placeholder="350">
                        </div>
                        <div class="form-group">
                            <label for="barcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
                            <input type="text" id="barcode" name="barcode" placeholder="4820000001234">
                        </div>
                        <div class="form-group">
                            <label for="pieces_per_box" class="required">–®—Ç—É–∫ –≤ —è—â–∏–∫—É</label>
                            <input type="number" id="pieces_per_box" name="pieces_per_box" min="1" required placeholder="12">
                        </div>
                        <div class="form-group">
                            <label for="stock_pieces">–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ø–∞—Å (—à—Ç—É–∫)</label>
                            <input type="number" id="stock_pieces" name="stock_pieces" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="stock_boxes">–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ø–∞—Å (—è—â–∏–∫—ñ–≤)</label>
                            <input type="number" id="stock_boxes" name="stock_boxes" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label for="min_stock_pieces">–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å (—à—Ç—É–∫)</label>
                            <input type="number" id="min_stock_pieces" name="min_stock_pieces" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                üìã –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤
            </div>
            <div class="card-body">
                <div id="products-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤...</div>
                <div id="products-content" style="display: none;">
                    <div class="table-container">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="col-xs">ID</th>
                                    <th class="col-lg">–ù–∞–∑–≤–∞</th>
                                    <th class="col-sm">–ö–æ–¥</th>
                                    <th class="col-sm">–í–∞–≥–∞</th>
                                    <th class="col-sm">–®—Ç/–Ø—â</th>
                                    <th class="col-sm">–ó–∞–ø–∞—Å (—à—Ç)</th>
                                    <th class="col-sm">–ó–∞–ø–∞—Å (—è—â)</th>
                                    <th class="col-sm">–ú—ñ–Ω. –∑–∞–ø–∞—Å</th>
                                    <th class="col-md">–°—Ç–∞—Ç—É—Å</th>
                                    <th class="col-md text-right table-actions">–î—ñ—ó</th>
                                </tr>
                            </thead>
                            <tbody id="products-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–æ–≤–∞—Ä</h3>
                <button class="close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-id" name="id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-name">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="edit-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-code">–ö–æ–¥ —Ç–æ–≤–∞—Ä—É</label>
                            <input type="text" id="edit-code" name="code" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-weight">–í–∞–≥–∞ (–≥)</label>
                            <input type="number" id="edit-weight" name="weight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-barcode">–®—Ç—Ä–∏—Ö–∫–æ–¥</label>
                            <input type="text" id="edit-barcode" name="barcode">
                        </div>
                        <div class="form-group">
                            <label for="edit-pieces_per_box">–®—Ç—É–∫ –≤ —è—â–∏–∫—É</label>
                            <input type="number" id="edit-pieces_per_box" name="pieces_per_box" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-stock_pieces">–ó–∞–ø–∞—Å (—à—Ç—É–∫)</label>
                            <input type="number" id="edit-stock_pieces" name="stock_pieces" min="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="edit-stock_boxes">–ó–∞–ø–∞—Å (—è—â–∏–∫—ñ–≤)</label>
                            <input type="number" id="edit-stock_boxes" name="stock_boxes" min="0" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label for="edit-min_stock_pieces">–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å</label>
                            <input type="number" id="edit-min_stock_pieces" name="min_stock_pieces" min="0">
                        </div>
                    </div>
                    <div class="product-form-hint">
                        –ó–∞–ª–∏—à–∫–∏ —Ç–æ–≤–∞—Ä—É –∑–º—ñ–Ω—é—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ, —Å–ø–∏—Å–∞–Ω–Ω—è, –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞–±–æ –æ–ø—Ä–∏–±—É—Ç–∫—É–≤–∞–Ω–Ω—è. –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="edit-form" class="btn btn-success">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script src="/js/error-handler.js"></script>
    <script src="/js/navigation.js"></script>
    
    <script>
        const API_URL = '/api';
        let currentEditId = null;
        
     // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ XSS
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = text.toString();
    return div.innerHTML;
}

// –§—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ—á–Ω–æ—ó –≤—Å—Ç–∞–≤–∫–∏ HTML
function safeInnerHTML(element, htmlContent) {
    if (!element) return;
    element.innerHTML = htmlContent;
}   
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ DOM
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadStats();
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
        async function loadProducts() {
            const loadingEl = safeQuerySelector('#products-loading');
            const contentEl = safeQuerySelector('#products-content');

            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';

                const response = await fetch(`${API_URL}/products`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
                
                const products = await response.json();
                displayProducts(products);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'block';
            } catch (error) {
                logError('Failed to load products', 'PRODUCTS_LOAD_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤: ' + error.message);
                
                if (loadingEl) {
                    loadingEl.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤';
                }
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                
                const stats = await response.json();
                
                const statsElements = {
                    'total-products': stats.total_products,
                    'total-pieces': stats.total_stock_pieces,
                    'total-boxes': stats.total_stock_boxes,
                    'low-stock': stats.low_stock_count
                };

                Object.entries(statsElements).forEach(([id, value]) => {
                    const element = safeQuerySelector(`#${id}`);
                    if (element) {
                        element.textContent = value;
                    }
                });
            } catch (error) {
                logError('Failed to load stats', 'STATS_LOAD_ERROR', error);
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
        function displayProducts(products) {
    const tbody = safeQuerySelector('#products-tbody');
    if (!tbody) {
        logError('Products table body not found', 'DOM_ERROR');
        return;
    }

    tbody.innerHTML = '';

    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="table-empty">–ù–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</td></tr>';
        return;
    }

    products.forEach(product => {
        const row = document.createElement('tr');
        const stockClass = getStockClass(product.stock_status);
        const statusText = getStatusText(product.stock_status);
        
        safeInnerHTML(row, `
            <td>${parseInt(product.id)}</td>
            <td><strong>${escapeHtml(product.name)}</strong></td>
            <td><code>${escapeHtml(product.code)}</code></td>
            <td>${escapeHtml(product.weight)}–≥</td>
            <td>${parseInt(product.pieces_per_box)}</td>
            <td>${parseInt(product.stock_pieces)}</td>
            <td>${parseInt(product.stock_boxes)}</td>
            <td>${parseInt(product.min_stock_pieces)}</td>
            <td><span class="${stockClass}">${escapeHtml(statusText)}</span></td>
            <td class="table-actions">
                <button class="btn btn-warning btn-small" onclick="editProduct(${parseInt(product.id)})" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-small" onclick="deleteProduct(${parseInt(product.id)}, '${escapeHtml(product.name)}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
            </td>
        `);
        tbody.appendChild(row);
    });
}

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä—É
        const productForm = safeQuerySelector('#product-form');
        if (productForm) {
            productForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const productData = Object.fromEntries(formData.entries());
                
                try {
                    const response = await fetch(`${API_URL}/products`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É');
                    }

                    showUserError('–¢–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!', 'success');
                    clearForm();
                    loadProducts();
                    loadStats();
                } catch (error) {
                    logError('Failed to create product', 'PRODUCT_CREATE_ERROR', error);
                    showUserError('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + error.message);
                }
            });
        }

        // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É
        async function editProduct(id) {
            try {
                const response = await fetch(`${API_URL}/products/${id}`);
                if (!response.ok) throw new Error('–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                
                const product = await response.json();
                
                const editElements = {
                    'edit-id': product.id,
                    'edit-name': product.name,
                    'edit-code': product.code,
                    'edit-weight': product.weight,
                    'edit-barcode': product.barcode || '',
                    'edit-pieces_per_box': product.pieces_per_box,
                    'edit-stock_pieces': product.stock_pieces,
                    'edit-stock_boxes': product.stock_boxes,
                    'edit-min_stock_pieces': product.min_stock_pieces
                };

                Object.entries(editElements).forEach(([id, value]) => {
                    const element = safeQuerySelector(`#${id}`);
                    if (element) {
                        element.value = value;
                    }
                });
                
                currentEditId = id;
                const modal = safeQuerySelector('#edit-modal');
                if (modal) {
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                }
            } catch (error) {
                logError('Failed to load product for editing', 'PRODUCT_EDIT_LOAD_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + error.message);
            }
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω
        const editForm = safeQuerySelector('#edit-form');
        if (editForm) {
            editForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const productData = Object.fromEntries(formData.entries());
                delete productData.id;
                
                try {
                    const response = await fetch(`${API_URL}/products/${currentEditId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É');
                    }

                    showUserError('–¢–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                    closeEditModal();
                    loadProducts();
                    loadStats();
                } catch (error) {
                    logError('Failed to update product', 'PRODUCT_UPDATE_ERROR', error);
                    showUserError('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + error.message);
                }
            });
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É
        async function deleteProduct(id, name) {
            if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É');
                }

                showUserError('–¢–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ!', 'success');
                loadProducts();
                loadStats();
            } catch (error) {
                logError('Failed to delete product', 'PRODUCT_DELETE_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + error.message);
            }
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function getStockClass(status) {
            return `stock-${status}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'good': '–î–æ—Å—Ç–∞—Ç–Ω—å–æ',
                'warning': '–£–≤–∞–≥–∞',
                'low': '–ù–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å'
            };
            return statusMap[status] || status;
        }

        function clearForm() {
            const form = safeQuerySelector('#product-form');
            if (form) {
                form.reset();
            }
        }

        function closeEditModal() {
            const modal = safeQuerySelector('#edit-modal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
            currentEditId = null;
        }

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
        window.onclick = function(event) {
            const modal = safeQuerySelector('#edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.refreshPageContent = function() {
            loadProducts();
            loadStats();
        };

        // –î–æ–¥–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('focus', function() {
            if (typeof window.refreshPageContent === 'function') {
                window.refreshPageContent();
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ó–∞–º–æ–≤–ª–µ–Ω—å - Pizza Inventory</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è—Ö */
        .product-batches-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .batches-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .batches-list {
            max-height: 120px;
            overflow-y: auto;
        }
        
        .batch-item-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.8rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .batch-item-mini:last-child {
            border-bottom: none;
        }
        
        .batch-date-mini {
            color: #7f8c8d;
        }
        
        .batch-quantity-mini {
            font-weight: 500;
            color: #27ae60;
        }
        
        .batch-status-mini {
            padding: 0.1rem 0.3rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .batch-status-mini.expiring {
            background: #fff3cd;
            color: #856404;
        }
        
        .availability-warning {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 0.25rem;
        }
        
        .availability-success {
            color: #27ae60;
            font-weight: 500;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è */
        .order-info-section,
        .order-items-section,
        .order-summary-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .order-info-section h3,
        .order-items-section h3,
        .order-summary-section h3 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-item-full {
            grid-column: 1 / -1;
        }

        .info-label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        .info-value {
            color: #2c3e50;
            font-size: 1rem;
            word-wrap: break-word;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .summary-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        .summary-value {
            font-weight: bold;
            color: #3498db;
            font-size: 1.1rem;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É */
        @media (max-width: 768px) {
            .order-info-section,
            .order-items-section,
            .order-summary-section {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .info-item {
                padding: 0.75rem;
                background: white;
                border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .summary-item {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
        }
        
        /* –Ü—Å–Ω—É—é—á—ñ —Å—Ç–∏–ª—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-confirmed { background: #f3e5f5; color: #7b1fa2; }
        .status-in_production { background: #fff3e0; color: #f57c00; }
        .status-ready { background: #e8f5e8; color: #388e3c; }
        .status-shipped { background: #e1f5fe; color: #0288d1; }
        .status-completed { background: #e8f5e8; color: #2e7d32; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–ª—ñ—î–Ω—Ç–∞ */
        .client-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        
        .client-summary h4 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-size: 1rem;
        }
        
        #clientPreview {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            min-height: 80px;
            font-size: 0.9rem;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        #clientPreview.preview-updating {
            opacity: 0.7;
            transform: scale(0.98);
        }
        
        #clientPreview.preview-updated {
            background: #e8f5e8;
            transform: scale(1.02);
        }
        
        #clientPreview em {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'create-order')">‚ûï –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
            <button class="tab" onclick="openTab(event, 'orders-list')">üìã –°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å</button>
            <button class="tab" onclick="openTab(event, 'clients-list')">üë• –ö–ª—ñ—î–Ω—Ç–∏</button>
        </div>

        <div id="create-order" class="tab-content active">
            <div class="section-title">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
            
            <form id="order-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="client-select">–ö–ª—ñ—î–Ω—Ç *</label>
                        <select id="client-select" name="client_id" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞...</option>
                        </select>
                        <button type="button" class="btn btn-small" onclick="showNewClientForm()" style="margin-top: 0.5rem;">‚ûï –ù–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç</button>
                    </div>
                    <div class="form-group">
                        <label for="client-info">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</label>
                        <textarea id="client-info" readonly style="background: #f8f9fa; resize: none;" rows="3" placeholder="–í–∏–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="order-date">–î–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è *</label>
                        <input type="date" id="order-date" name="order_date" required>
                    </div>
                    <div class="form-group">
                        <label for="delivery-date">–î–∞—Ç–∞ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
                        <input type="date" id="delivery-date" name="delivery_date">
                    </div>
                    <div class="form-group">
                        <label for="created-by">–ö–æ–º–µ—Ä—Ü—ñ–π–Ω–∏–π –¥–∏—Ä–µ–∫—Ç–æ—Ä *</label>
                        <input type="text" id="created-by" name="created_by" required placeholder="–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="order-notes">–ü—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                    <textarea id="order-notes" name="notes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..."></textarea>
                </div>

                <div class="section-title">–¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ</div>
                
                <div class="order-items" id="order-items">
                    <div class="order-item">
                        <div>
                            <select name="product_id" required style="width: 100%; margin-bottom: 0.5rem;">
                                <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>
                            </select>
                            <input type="text" name="item_notes" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –ø–æ–∑–∏—Ü—ñ—ó..." style="width: 100%;">
                        </div>
                        <div>
                            <input type="number" name="quantity" min="1" required placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å (—à—Ç)" style="width: 100%; margin-bottom: 0.5rem;">
                            <div class="quantity-info" style="font-size: 0.85rem; color: #7f8c8d;"></div>
                            <!-- –ù–æ–≤–∏–π –±–ª–æ–∫ –¥–ª—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó -->
                            <div class="product-batches-info" style="display: none;">
                                <div class="batches-summary">
                                    <span>üì¶ –î–æ—Å—Ç—É–ø–Ω—ñ –ø–∞—Ä—Ç—ñ—ó:</span>
                                    <span class="total-available">0 —à—Ç</span>
                                </div>
                                <div class="batches-list"></div>
                                <div class="availability-check"></div>
                            </div>
                        </div>
                        <div>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeOrderItem(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 1rem 0;">
                    <button type="button" class="btn" onclick="addOrderItem()">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                </div>

                <div id="order-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0; display: none;">
                    <strong>–ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</strong>
                    <div id="summary-content"></div>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
                <button type="button" class="btn" onclick="clearOrderForm()">üîÑ –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É</button>
            </form>
        </div>

        <!-- –Ü–Ω—à—ñ –≤–∫–ª–∞–¥–∫–∏ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω -->
        <div id="orders-list" class="tab-content">
            <div class="section-title">–°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
            
            <div id="orders-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å...</div>
            <div id="orders-content" style="display: none;">
                <table class="table" id="orders-table">
                    <thead>
                        <tr>
                            <th>‚Ññ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
                            <th>–ö–ª—ñ—î–Ω—Ç</th>
                            <th>–î–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</th>
                            <th>–î–∞—Ç–∞ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–¢–æ–≤–∞—Ä—ñ–≤</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="clients-list" class="tab-content">
            <div class="section-title">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏</div>
            
            <button class="btn btn-success" onclick="showNewClientForm()">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</button>
            
            <div id="clients-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤...</div>
            <div id="clients-content" style="display: none;">
                <table class="table" id="clients-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞</th>
                            <th>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th>Email</th>
                            <th>–ê–¥—Ä–µ—Å–∞</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody id="clients-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω -->
   
    <div id="client-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="client-modal-title">‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞</h2>
                <span class="modal-close" onclick="closeClientModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="client-form">
                    <input type="hidden" id="client-id" name="id">
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ -->
                    <div class="section-title">üë§ –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="client-name-modal" class="required">–ù–∞–∑–≤–∞ –∫–ª—ñ—î–Ω—Ç–∞</label>
                            <input type="text" id="client-name-modal" name="name" required 
                                placeholder="–¢–û–í –ü—ñ—Ü–∞ –ï–∫—Å–ø—Ä–µ—Å" 
                                autocomplete="organization">
                            <small>–ü–æ–≤–Ω–∞ –Ω–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó –∞–±–æ –ü–Ü–ë —Ñ—ñ–∑–∏—á–Ω–æ—ó –æ—Å–æ–±–∏</small>
                        </div>
                        <div class="form-group">
                            <label for="client-contact-person">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ –æ—Å–æ–±–∞</label>
                            <input type="text" id="client-contact-person" name="contact_person" 
                                placeholder="–Ü–≤–∞–Ω –ü–µ—Ç—Ä–µ–Ω–∫–æ" 
                                autocomplete="name">
                            <small>–ü–Ü–ë –æ—Å–æ–±–∏ –¥–ª—è –∑–≤'—è–∑–∫—É</small>
                        </div>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                    <div class="section-title" style="margin-top: 2rem;">üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="client-phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" id="client-phone" name="phone" 
                                placeholder="+380 67 123 45 67" 
                                autocomplete="tel">
                            <small>–û—Å–Ω–æ–≤–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –∑–≤'—è–∑–∫—É</small>
                        </div>
                        <div class="form-group">
                            <label for="client-email">Email –∞–¥—Ä–µ—Å–∞</label>
                            <input type="email" id="client-email" name="email" 
                                placeholder="contact@pizza.com" 
                                autocomplete="email">
                            <small>–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞ –¥–ª—è –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó</small>
                        </div>
                    </div>
                    
                    <!-- –ê–¥—Ä–µ—Å–∞ —Ç–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                    <div class="section-title" style="margin-top: 2rem;">üìç –ê–¥—Ä–µ—Å–∞ —Ç–∞ –ø—Ä–∏–º—ñ—Ç–∫–∏</div>
                    <div class="form-group">
                        <label for="client-address">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <textarea id="client-address" name="address" rows="3" 
                                placeholder="–º. –ö–∏—ó–≤, –≤—É–ª. –•—Ä–µ—â–∞—Ç–∏–∫, 1, –æ—Ñ—ñ—Å 101" 
                                autocomplete="street-address"></textarea>
                        <small>–ü–æ–≤–Ω–∞ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä—ñ–≤</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="client-notes">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø—Ä–∏–º—ñ—Ç–∫–∏</label>
                        <textarea id="client-notes" name="notes" rows="4" 
                                placeholder="–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏ –∑ –∫–ª—ñ—î–Ω—Ç–æ–º, —É–º–æ–≤–∏ –æ–ø–ª–∞—Ç–∏, –≥—Ä–∞—Ñ—ñ–∫ —Ä–æ–±–æ—Ç–∏ —Ç–æ—â–æ..."></textarea>
                        <small>–ë—É–¥—å-—è–∫–∞ –∫–æ—Ä–∏—Å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞</small>
                    </div>

                    <!-- –ü—ñ–¥—Å—É–º–æ–∫ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ -->
                    <div class="client-summary">
                        <h4>üìã –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</h4>
                        <div id="clientPreview">
                            –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="client-form" class="btn btn-success">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeClientModal()">
                    ‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            </div>
        </div>
</div>

    <div id="view-order-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="view-order-title">üìã –ü–µ—Ä–µ–≥–ª—è–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
                <span class="modal-close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="order-details">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">
                    ‚ùå –ó–∞–∫—Ä–∏—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <script src="/js/error-handler.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script>
        const API_URL = '/api';
        let products = [];
        let clients = [];
        let currentOrderId = null;
        let currentClientId = null;
        let productBatches = {}; // –ö–µ—à –ø–∞—Ä—Ç—ñ–π –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö

        // –§—É–Ω–∫—Ü—ñ—è –µ–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è HTML –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ XSS
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text.toString();
            return div.innerHTML;
        }

        // –§—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ—á–Ω–æ—ó –≤—Å—Ç–∞–≤–∫–∏ HTML
        function safeInnerHTML(element, htmlContent) {
            if (!element) return;
            element.innerHTML = htmlContent;
        }    

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
            const isAuthenticated = await authManager.requireAuth();
            if (isAuthenticated) {
                loadProducts();
                loadClients();
                loadOrders();
                
                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É
                document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('client-select').addEventListener('change', updateClientInfo);
                if (typeof orderEditor !== 'undefined' && orderEditor.init) orderEditor.init();
                if (typeof setupModalHandlers !== 'undefined') setupModalHandlers();
            }
        });

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó
        async function loadProducts() {
    try {
        const productsResponse = await fetch(`${API_URL}/products`);
        if (!productsResponse.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤');
        
        const productsData = await productsResponse.json();
        
        // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API: {success: true, data: [...]}
        products = productsData.success ? productsData.data : productsData;
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–∞—Ä—Ç—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä—É
        productBatches = {};
        const batchPromises = products.map(async (product) => {
            try {
                const batchResponse = await fetch(`${API_URL}/products/${product.id}/batches`);
                if (batchResponse.ok) {
                    const batchData = await batchResponse.json();
                    const batches = batchData.success ? batchData.data : batchData;
                    const totalAvailable = batches.reduce((sum, b) => sum + (b.available_quantity || 0), 0);
                    productBatches[product.id] = {
                        total_available: totalAvailable,
                        batches: batches
                    };
                } else {
                    productBatches[product.id] = { total_available: 0, batches: [] };
                }
            } catch (error) {
                console.warn(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π –¥–ª—è —Ç–æ–≤–∞—Ä—É ${product.id}:`, error);
                productBatches[product.id] = { total_available: 0, batches: [] };
            }
        });
        
        await Promise.all(batchPromises);
        updateProductSelects();
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:', error);
        showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤: ' + error.message, 'error');
    }
}

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç—ñ–≤ —Ç–æ–≤–∞—Ä—ñ–≤
        function updateProductSelects() {
            const selects = document.querySelectorAll('select[name="product_id"]');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>';
                
                products.forEach(product => {
                    const batchInfo = productBatches[product.id];
                    const totalAvailable = batchInfo ? batchInfo.total_available : 0;
                    
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.code}) - ${totalAvailable} —à—Ç –¥–æ—Å—Ç—É–ø–Ω–æ`;
                    option.setAttribute('data-pieces-per-box', product.pieces_per_box);
                    option.setAttribute('data-available', totalAvailable);
                    
                    // –î–æ–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω—É –æ–∑–Ω–∞–∫—É –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –Ω–∏–∑—å–∫–∏–º–∏ –∑–∞–ª–∏—à–∫–∞–º–∏
                    if (totalAvailable < product.min_stock_pieces) {
                        option.style.color = '#e74c3c';
                        option.textContent += ' ‚ö†Ô∏è';
                    }
                    
                    select.appendChild(option);
                });
                
                select.value = currentValue;
                if (currentValue) {
                    const item = select.closest('.order-item');
                    updateProductBatchesInfo(item);
                }
            });
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–∞—Ä—Ç—ñ—ó —Ç–æ–≤–∞—Ä—É
        function updateProductBatchesInfo(item) {
            const select = item.querySelector('select[name="product_id"]');
            const batchesInfo = item.querySelector('.product-batches-info');
            const batchesList = item.querySelector('.batches-list');
            const totalAvailableSpan = item.querySelector('.total-available');
            
            if (!select.value || !batchesInfo) {
                if (batchesInfo) batchesInfo.style.display = 'none';
                return;
            }
            
            const productId = select.value;
            const batchInfo = productBatches[productId];
            console.log('Batch info for product', productId, ':', batchInfo); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            
            if (!batchInfo || !batchInfo.batches || batchInfo.batches.length === 0) {
                console.log('No batches found for product', productId);
                batchesInfo.style.display = 'none';
                return;
            }
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å
            totalAvailableSpan.textContent = `${batchInfo.total_available} —à—Ç`;
            
            // –ì–µ–Ω–µ—Ä—É—î–º–æ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç—ñ–π
            const batchesHTML = batchInfo.batches.map(batch => {
                const batchDate = new Date(batch.batch_date).toLocaleDateString('uk-UA');
                let statusClass = '';
                let statusText = '';
                
                if (batch.status === 'EXPIRING') {
                    statusClass = 'expiring';
                    statusText = `‚ö†Ô∏è ${batch.days_to_expiry} –¥–Ω.`;
                } else if (batch.status === 'EXPIRED') {
                    statusClass = 'expired';
                    statusText = '‚ùå –ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∞';
                }
                
                return `
                    <div class="batch-item-mini">
                        <span class="batch-date-mini">${batchDate}</span>
                        <span class="batch-quantity-mini">${batch.available_quantity} —à—Ç</span>
                        ${statusText ? `<span class="batch-status-mini ${statusClass}">${statusText}</span>` : ''}
                    </div>
                `;
            }).join('');
            
            batchesList.innerHTML = batchesHTML;
            batchesInfo.style.display = 'block';
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
            updateAvailabilityCheck(item);
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—É
        function updateAvailabilityCheck(item) {
            const select = item.querySelector('select[name="product_id"]');
            const quantityInput = item.querySelector('input[name="quantity"]');
            const availabilityCheck = item.querySelector('.availability-check');
            
            if (!select.value || !quantityInput.value || !availabilityCheck) {
                if (availabilityCheck) availabilityCheck.innerHTML = '';
                return;
            }
            
            const productId = select.value;
            const quantityNeeded = parseInt(quantityInput.value) || 0;
            const batchInfo = productBatches[productId];
            const totalAvailable = batchInfo ? batchInfo.total_available : 0;
            
            if (quantityNeeded > totalAvailable) {
                const shortage = quantityNeeded - totalAvailable;
                availabilityCheck.innerHTML = `
                    <div class="availability-warning">
                        ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—á–∞: ${shortage} —à—Ç. –î–æ—Å—Ç—É–ø–Ω–æ: ${totalAvailable} —à—Ç
                        <br><small style="color: #856404;">üí° –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏. –ù–µ–¥–æ—Å—Ç–∞—á–∞ –±—É–¥–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏—Å—è –≤ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—ñ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞.</small>
                    </div>
                `;
            } else if (quantityNeeded > 0) {
                availabilityCheck.innerHTML = `
                    <div class="availability-success">
                        ‚úÖ –¢–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è (${totalAvailable} —à—Ç)
                    </div>
                `;
            } else {
                availabilityCheck.innerHTML = '';
            }
        }


        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∫–ª–∞–¥–∫–∞–º–∏
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove("active");
            }
            
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // –ü—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'clients-list') {
                loadClients();
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        async function loadClients() {
            try {
                const response = await fetch(`${API_URL}/clients`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤');
                
                const clientsData = await response.json();
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API: {success: true, data: [...]}
                clients = clientsData.success ? clientsData.data : clientsData;
                
                updateClientSelect();
                displayClients();
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤: ' + error.message, 'error');
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        function updateClientSelect() {
            const select = safeQuerySelector('#client-select');
            if (!select) return;
            
            const currentValue = select.value;
            const newOptions = ['<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞...</option>'];
            
            clients.forEach(client => {
                const clientId = parseInt(client.id);
                const clientName = escapeHtml(client.name);
                const contactPerson = escapeHtml(client.contact_person || '');
                const phone = escapeHtml(client.phone || '');
                const email = escapeHtml(client.email || '');
                const address = escapeHtml(client.address || '');
                
                newOptions.push(`
                    <option value="${clientId}" 
                            data-contact-person="${contactPerson}"
                            data-phone="${phone}" 
                            data-email="${email}" 
                            data-address="${address}">
                        ${clientName}
                    </option>
                `);
            });
            
            select.innerHTML = newOptions.join('');
            
            if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                select.value = currentValue;
            }
            
            updateClientInfo();
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        function updateClientInfo() {
            const select = document.getElementById('client-select');
            const infoField = document.getElementById('client-info');
            
            if (!select.value) {
                infoField.value = '';
                return;
            }
            
            const selectedOption = select.selectedOptions[0];
            const contactPerson = selectedOption.getAttribute('data-contact-person');
            const phone = selectedOption.getAttribute('data-phone');
            const email = selectedOption.getAttribute('data-email');
            const address = selectedOption.getAttribute('data-address');
            
            let info = [];
            if (contactPerson) info.push(`–ö–æ–Ω—Ç–∞–∫—Ç: ${contactPerson}`);
            if (phone) info.push(`–¢–µ–ª: ${phone}`);
            if (email) info.push(`Email: ${email}`);
            if (address) info.push(`–ê–¥—Ä–µ—Å–∞: ${address}`);
            
            infoField.value = info.join('\n');
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –ø–æ–∑–∏—Ü—ñ—ó –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        function addOrderItem() {
            const container = document.getElementById('order-items');
            const newItem = container.firstElementChild.cloneNode(true);
            
            // –û—á–∏—â—É—î–º–æ –ø–æ–ª—è
            newItem.querySelector('select').value = '';
            newItem.querySelector('input[name="quantity"]').value = '';
            newItem.querySelector('input[name="item_notes"]').value = '';
            newItem.querySelector('.quantity-info').textContent = '';
            newItem.querySelector('.product-batches-info').style.display = 'none';
            newItem.querySelector('.batches-list').innerHTML = '';
            newItem.querySelector('.availability-check').innerHTML = '';
            
            container.appendChild(newItem);
            updateProductSelects();
            setupItemEvents(newItem);
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –∑ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        function removeOrderItem(button) {
            const container = document.getElementById('order-items');
            if (container.children.length > 1) {
                button.closest('.order-item').remove();
                updateOrderSummary();
            }
        }

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–ª—è –ø–æ–∑–∏—Ü—ñ—ó
        function setupItemEvents(item) {
            const select = item.querySelector('select[name="product_id"]');
            const quantityInput = item.querySelector('input[name="quantity"]');
            
            select.addEventListener('change', function() {
                updateQuantityInfo(item);
                updateProductBatchesInfo(item);
                updateOrderSummary();
            });
            
            quantityInput.addEventListener('input', function() {
                updateQuantityInfo(item);
                updateAvailabilityCheck(item);
                updateOrderSummary();
            });
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        function updateQuantityInfo(item) {
            const select = item.querySelector('select[name="product_id"]');
            const quantityInput = item.querySelector('input[name="quantity"]');
            const infoDiv = item.querySelector('.quantity-info');
            
            const selectedOption = select.selectedOptions[0];
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (!selectedOption || !quantity) {
                infoDiv.textContent = '';
                return;
            }
            
            const piecesPerBox = parseInt(selectedOption.getAttribute('data-pieces-per-box'));
            const available = parseInt(selectedOption.getAttribute('data-available'));
            
            const boxes = Math.floor(quantity / piecesPerBox);
            const pieces = quantity % piecesPerBox;
            
            let info = `${boxes} —è—â + ${pieces} —à—Ç`;
            if (quantity > available) {
                info += ` (‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –Ω–∞ —Å–∫–ª–∞–¥—ñ: ${available} —à—Ç)`;
                infoDiv.style.color = '#e74c3c';
            } else {
                infoDiv.style.color = '#27ae60';
            }
            
            infoDiv.textContent = info;
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥—Å—É–º–∫—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        function updateOrderSummary() {
            const items = document.querySelectorAll('.order-item');
            let totalQuantity = 0;
            let totalBoxes = 0;
            let hasItems = false;
            
            items.forEach(item => {
                const select = item.querySelector('select[name="product_id"]');
                const quantityInput = item.querySelector('input[name="quantity"]');
                
                if (select.value && quantityInput.value) {
                    hasItems = true;
                    const quantity = parseInt(quantityInput.value);
                    const piecesPerBox = parseInt(select.selectedOptions[0].getAttribute('data-pieces-per-box'));
                    
                    totalQuantity += quantity;
                    totalBoxes += Math.floor(quantity / piecesPerBox);
                }
            });
            
            const summaryDiv = document.getElementById('order-summary');
            const contentDiv = document.getElementById('summary-content');
            
            if (hasItems) {
                contentDiv.innerHTML = `
                    –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: <strong>${totalQuantity} —à—Ç</strong><br>
                    –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —è—â–∏–∫—ñ–≤: <strong>${totalBoxes} —è—â</strong>
                `;
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–ª—è —ñ—Å–Ω—É—é—á–æ—ó –ø–æ–∑–∏—Ü—ñ—ó
        document.addEventListener('DOMContentLoaded', function() {
            const firstItem = document.querySelector('.order-item');
            if (firstItem) {
                setupItemEvents(firstItem);
            }
        });

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
        document.getElementById('order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ –æ–±—Ä–∞–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
            const clientSelect = document.getElementById('client-select');
            const selectedOption = clientSelect.selectedOptions[0];
            
            if (!clientSelect.value) {
                showAlert('–û–±–µ—Ä—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', 'error');
                return;
            }
            
            const orderData = {
                client_id: parseInt(clientSelect.value),
                client_name: selectedOption.textContent,
                client_contact: document.getElementById('client-info').value,
                order_date: formData.get('order_date'),
                delivery_date: formData.get('delivery_date'),
                notes: formData.get('notes'),
                created_by: formData.get('created_by'),
                items: []
            };
            
            // –ó–±–∏—Ä–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
            const items = document.querySelectorAll('.order-item');
                    
            items.forEach(item => {
                const productId = item.querySelector('select[name="product_id"]').value;
                const quantity = item.querySelector('input[name="quantity"]').value;
                const notes = item.querySelector('input[name="item_notes"]').value;
                
                if (productId && quantity) {
                    const quantityNum = parseInt(quantity);
                    const batchInfo = productBatches[productId];
                    const totalAvailable = batchInfo ? batchInfo.total_available : 0;
                    
                    orderData.items.push({
                        product_id: productId,
                        quantity: quantityNum,
                        notes: notes
                    });
                    
                    // –ó–±–∏—Ä–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –Ω–µ–¥–æ—Å—Ç–∞—á—É –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
                    if (quantityNum > totalAvailable) {
                        const shortage = quantityNum - totalAvailable;
                        const productName = item.querySelector('select option:checked').textContent;
                        orderData.shortages = orderData.shortages || [];
                        orderData.shortages.push({
                            product_name: productName,
                            needed: quantityNum,
                            available: totalAvailable,
                            shortage: shortage
                        });
                    }
                }
            });
             // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–¥–æ—Å—Ç–∞—á—É (—è–∫—â–æ —î)
                if (orderData.shortages && orderData.shortages.length > 0) {
                    const shortageText = orderData.shortages.map(s => 
                        `${s.product_name}: –Ω–µ–¥–æ—Å—Ç–∞—á–∞ ${s.shortage} —à—Ç`
                    ).join('\n');
                    
                    const confirmCreate = confirm(
                        `‚ö†Ô∏è –£–í–ê–ì–ê: –í–∏—è–≤–ª–µ–Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—á—É —Ç–æ–≤–∞—Ä—ñ–≤:\n\n${shortageText}\n\n` +
                        `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ, –∞–ª–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ –∑–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ.\n\n` +
                        `–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?`
                    );
                    
                    if (!confirmCreate) {
                        return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–º—ñ–Ω–∏–≤ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
                    }
                }           
                       
            if (orderData.items.length === 0) {
                showAlert('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è', 'error');
                return;
            }
           
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è';
                    
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMsg = errorData.error;
                        } else if (errorData.error.message) {
                            errorMsg = errorData.error.message;
                        } else if (errorData.error.details) {
                            errorMsg = errorData.error.details;
                        }
                    } else if (errorData.message) {
                        errorMsg = errorData.message;
                    }
                    
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                const orderInfo = result.success ? result.data : result;
                const orderNumber = orderInfo.order_number || orderInfo.id;
                
                showAlert(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ${orderNumber} —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ! –ü–∞—Ä—Ç—ñ—ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–æ.`, 'success');
                clearOrderForm();
                loadOrders(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å
                loadProducts(); // –û–Ω–æ–≤–ª—é—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + error.message, 'error');
            }
        });

        // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        function clearOrderForm() {
            document.getElementById('order-form').reset();
            document.getElementById('order-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('client-info').value = '';
            
            // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω—É –ø–æ–∑–∏—Ü—ñ—é
            const container = document.getElementById('order-items');
            const firstItem = container.firstElementChild;
            container.innerHTML = '';
            container.appendChild(firstItem);
            
            // –û—á–∏—â—É—î–º–æ –ø–µ—Ä—à—É –ø–æ–∑–∏—Ü—ñ—é
            firstItem.querySelector('select').value = '';
            firstItem.querySelector('input[name="quantity"]').value = '';
            firstItem.querySelector('input[name="item_notes"]').value = '';
            firstItem.querySelector('.quantity-info').textContent = '';
            firstItem.querySelector('.product-batches-info').style.display = 'none';
            firstItem.querySelector('.availability-check').innerHTML = '';
            
            updateProductSelects();
            document.getElementById('order-summary').style.display = 'none';
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        async function loadOrders() {
            try {
                document.getElementById('orders-loading').style.display = 'block';
                document.getElementById('orders-content').style.display = 'none';

                const response = await fetch(`${API_URL}/orders`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å');
                
                const ordersData = await response.json();
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API: {success: true, data: [...]}
                const orders = ordersData.success ? ordersData.data : ordersData;
                
                displayOrders(orders);
                
                document.getElementById('orders-loading').style.display = 'none';
                document.getElementById('orders-content').style.display = 'block';
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å:', error);
                document.getElementById('orders-loading').innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å';
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        function displayOrders(orders) {
            const tbody = safeQuerySelector('#orders-tbody');
            if (!tbody) {
                logError('Orders table body not found', 'DOM_ERROR');
                return;
            }

            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7f8c8d;">–ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</td></tr>';
                return;
            }

            // –°–æ—Ä—Ç—É—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–∞ order_number (–Ω–æ–≤—ñ –∑–≤–µ—Ä—Ö—É)
            orders.sort((a, b) => {
                if (!a.order_number || !b.order_number) return 0;
                const numA = a.order_number.replace(/\D/g, '');
                const numB = b.order_number.replace(/\D/g, '');
                return numB.localeCompare(numA, undefined, { numeric: true });
            });

            orders.forEach(order => {
                const row = document.createElement('tr');
                const orderDate = new Date(order.order_date).toLocaleDateString('uk-UA');
                const deliveryDate = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('uk-UA') : '-';
                const statusClass = `status-${order.status.toLowerCase()}`;
                const statusText = getStatusText(order.status);
                const actionsHtml = `
                    <td>
                        <button class="btn btn-small btn-info" onclick="viewOrder(${parseInt(order.id)})" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                        <button class="btn btn-small btn-warning edit-order-btn" data-order-id="${parseInt(order.id)}" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                        <button class="btn btn-small btn-secondary" onclick="changeStatus(${parseInt(order.id)}, '${escapeHtml(order.status)}')" title="–ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å">üìù –°—Ç–∞—Ç—É—Å</button>
                        <button class="btn btn-small btn-secondary" onclick="printOrderPDF(${parseInt(order.id)})" title="–î—Ä—É–∫ PDF">üìÑ PDF</button>
                        <button class="btn btn-small btn-danger" onclick="deleteOrder(${parseInt(order.id)}, '${escapeHtml(order.order_number)}', '${escapeHtml(order.client_name)}')" title="–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    </td>
                `;
                safeInnerHTML(row, `
                    <td><strong>${escapeHtml(order.order_number)}</strong></td>
                    <td>${escapeHtml(order.client_name)}</td>
                    <td>${escapeHtml(orderDate)}</td>
                    <td>${escapeHtml(deliveryDate)}</td>
                    <td><span class="status-badge ${statusClass}">${escapeHtml(statusText)}</span></td>
                    <td>${escapeHtml(order.items_count || 0)}</td>
                    <td>${escapeHtml(order.total_quantity || 0)} —à—Ç</td>
                    ${actionsHtml}
                `);
                tbody.appendChild(row);
            });
        }

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É —Å—Ç–∞—Ç—É—Å—É (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        function getStatusText(status) {
            const statusMap = {
                'NEW': '–ù–æ–≤–µ',
                'CONFIRMED': '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–µ',
                'IN_PRODUCTION': '–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ',
                'READY': '–ì–æ—Ç–æ–≤–µ',
                'SHIPPED': '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ',
                'COMPLETED': '–ó–∞–≤–µ—Ä—à–µ–Ω–µ'
            };
            return statusMap[status] || status;
        }

        // –ü–µ—Ä–µ–≥–ª—è–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ –ø–∞—Ä—Ç—ñ—ó
        async function viewOrder(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
                
                const orderData = await response.json();
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API: {success: true, data: {...}}
                const order = orderData.success ? orderData.data : orderData;
                
                displayOrderDetails(order);
                
                // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
                const modal = document.getElementById('view-order-modal');
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –≤–µ—Ä—Ö—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
                const modalBody = modal.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.scrollTop = 0;
                }
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        closeViewModal();
                    }
                };
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ ESC –∫–ª–∞–≤—ñ—à—ñ
                const escapeHandler = function(event) {
                    if (event.key === 'Escape') {
                        closeViewModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + error.message, 'error');
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –ø–∞—Ä—Ç—ñ—è–º–∏
        function displayOrderDetails(order) {
            // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
            const titleElement = document.getElementById('view-order-title');
            if (titleElement) {
                titleElement.textContent = `üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ${order.order_number}`;
            }
            
            const detailsDiv = document.getElementById('order-details');
            const orderDate = new Date(order.order_date).toLocaleDateString('uk-UA');
            const deliveryDate = order.delivery_date ? new Date(order.delivery_date).toLocaleDateString('uk-UA') : '–ù–µ –≤–∫–∞–∑–∞–Ω–∞';
            const statusText = getStatusText(order.status);
            
            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                itemsHtml = order.items.map(item => {
                    let batchesInfo = '';
                    if (item.allocated_batches && item.allocated_batches.length > 0) {
                        console.log('Allocated batches:', item.allocated_batches); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                        const batchesText = item.allocated_batches.map(batch => {
                            const date = batch.batch_date || '–ù–µ–≤—ñ–¥–æ–º–∞ –¥–∞—Ç–∞';
                            const qty = batch.quantity || batch.allocated_quantity || 0;
                            return `${date}: ${qty} —à—Ç`;
                        }).join(', ');
                        batchesInfo = `<br><small style="color: #7f8c8d;">üì¶ –ó–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ –ø–∞—Ä—Ç—ñ—ó: ${batchesText}</small>`;
                    }
                    
                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(item.product_name)}</strong> (${escapeHtml(item.product_code)})
                                ${batchesInfo}
                            </td>
                            <td>${escapeHtml(item.quantity)} —à—Ç</td>
                            <td>${escapeHtml(item.boxes)} —è—â + ${escapeHtml(item.pieces)} —à—Ç</td>
                            <td>${escapeHtml(item.notes || '-')}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            detailsDiv.innerHTML = `
                <div class="order-info-section">
                    <h3>‚ÑπÔ∏è –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">üë§ –ö–ª—ñ—î–Ω—Ç:</span>
                            <span class="info-value">${escapeHtml(order.client_name)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìû –ö–æ–Ω—Ç–∞–∫—Ç–∏:</span>
                            <span class="info-value">${escapeHtml(order.client_contact || '-')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìÖ –î–∞—Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</span>
                            <span class="info-value">${orderDate}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üöö –î–∞—Ç–∞ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</span>
                            <span class="info-value">${deliveryDate}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìä –°—Ç–∞—Ç—É—Å:</span>
                            <span class="info-value"><span class="status-badge status-${order.status.toLowerCase()}">${statusText}</span></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üë®‚Äçüíº –°—Ç–≤–æ—Ä–∏–≤:</span>
                            <span class="info-value">${escapeHtml(order.created_by)}</span>
                        </div>
                        ${order.notes ? `
                        <div class="info-item info-item-full">
                            <span class="info-label">üìù –ü—Ä–∏–º—ñ—Ç–∫–∏:</span>
                            <span class="info-value">${escapeHtml(order.notes)}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="order-items-section">
                    <h3>üì¶ –¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä</th>
                                    <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                                    <th>–£–ø–∞–∫–æ–≤–∫–∞</th>
                                    <th>–ü—Ä–∏–º—ñ—Ç–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="order-summary-section">
                    <h3>üìä –ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">üìã –ü–æ–∑–∏—Ü—ñ–π:</span>
                            <span class="summary-value">${order.items ? order.items.length : 0}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üì¶ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å:</span>
                            <span class="summary-value">${order.total_quantity} —à—Ç</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üì¶ –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —è—â–∏–∫—ñ–≤:</span>
                            <span class="summary-value">${order.total_boxes} —è—â</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        function closeViewModal() {
            const modal = document.getElementById('view-order-modal');
            if (modal) {
                modal.classList.remove('show');
                
                // –í–∏–¥–∞–ª—è—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
                modal.onclick = null;
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–∫—Ä–∏—Ç—Ç—è
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                
                document.body.style.overflow = 'auto';
            }
        }

        // –ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        function changeStatus(orderId, currentStatus) {
            const statuses = [
                { value: 'NEW', text: '–ù–æ–≤–µ' },
                { value: 'CONFIRMED', text: '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–µ' },
                { value: 'IN_PRODUCTION', text: '–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ' },
                { value: 'READY', text: '–ì–æ—Ç–æ–≤–µ' },
                { value: 'SHIPPED', text: '–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ' },
                { value: 'COMPLETED', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–µ' }
            ];
            
            const newStatus = prompt(`–û–±–µ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å:\n\n${statuses.map((s, i) => `${i + 1}. ${s.text}`).join('\n')}\n\n–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä (1-6):`);
            
            if (newStatus && newStatus >= 1 && newStatus <= 6) {
                const selectedStatus = statuses[newStatus - 1].value;
                updateOrderStatus(orderId, selectedStatus);
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        status: status,
                        updated_by: '–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.error || errorData.message || '–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É';
                    throw new Error(errorMsg);
                }

                showAlert('–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!', 'success');
                loadOrders(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É: ' + error.message, 'error');
            }
        }

        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω - —Å–∫–æ—Ä–æ—á–µ–Ω–æ –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è)
        function displayClients() {
            const tbody = document.getElementById('clients-tbody');
            const loading = document.getElementById('clients-loading');
            const content = document.getElementById('clients-content');

            if (!tbody) {
                console.error('clients-tbody not found!');
                return;
            }

            if (content) content.style.display = 'block';
            if (loading) loading.style.display = 'none';

            tbody.innerHTML = '';

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">–ù–µ–º–∞—î –∫–ª—ñ—î–Ω—Ç—ñ–≤</td></tr>';
            } else {
                clients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.id}</td>
                        <td><strong>${client.name}</strong></td>
                        <td>${client.contact_person || '-'}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td>${client.address || '-'}</td>
                        <td>
                            <button class="btn btn-warning btn-small" onclick="editClient(${client.id})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                            <button class="btn btn-danger btn-small" onclick="deleteClient(${client.id}, '${client.name}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

                // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        async function editClient(clientId) {
            try {
                const response = await fetch(`${API_URL}/clients/${clientId}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMsg = '–ö–ª—ñ—î–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                    
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMsg = errorData.error;
                        } else if (errorData.error.message) {
                            errorMsg = errorData.error.message;
                        } else if (errorData.error.details) {
                            errorMsg = errorData.error.details;
                        }
                    } else if (errorData.message) {
                        errorMsg = errorData.message;
                    }
                    
                    throw new Error(errorMsg);
                }
                
                const clientData = await response.json();
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API: {success: true, data: {...}}
                const client = clientData.success ? clientData.data : clientData;
                
                currentClientId = clientId;
                document.getElementById('client-modal-title').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞';
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name-modal').value = client.name;
                document.getElementById('client-contact-person').value = client.contact_person || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-address').value = client.address || '';
                document.getElementById('client-notes').value = client.notes || '';
                
                // –ü–µ—Ä–µ–Ω–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
                setupClientPreview();
                
                document.getElementById('client-modal').style.display = 'block';
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: ' + error.message, 'error');
            }
        }

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        document.getElementById('client-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const clientData = Object.fromEntries(formData.entries());
            delete clientData.id;
            
            try {
                const isEditing = currentClientId !== null;
                const url = isEditing ? `${API_URL}/clients/${currentClientId}` : `${API_URL}/clients`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(clientData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞';
                    
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMsg = errorData.error;
                        } else if (errorData.error.message) {
                            errorMsg = errorData.error.message;
                        } else if (errorData.error.details) {
                            errorMsg = errorData.error.details;
                        }
                    } else if (errorData.message) {
                        errorMsg = errorData.message;
                    }
                    
                    throw new Error(errorMsg);
                }

                showAlert(`–ö–ª—ñ—î–Ω—Ç–∞ ${isEditing ? '–æ–Ω–æ–≤–ª–µ–Ω–æ' : '—Å—Ç–≤–æ—Ä–µ–Ω–æ'} —É—Å–ø—ñ—à–Ω–æ!`, 'success');
                closeClientModal();
                loadClients();
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: ' + error.message, 'error');
            }
        });

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ (–∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω)
        async function deleteClient(clientId, clientName) {
            if (!confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞ "${clientName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/clients/${clientId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞';
                    
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMsg = errorData.error;
                        } else if (errorData.error.message) {
                            errorMsg = errorData.error.message;
                        } else if (errorData.error.details) {
                            errorMsg = errorData.error.details;
                        }
                    } else if (errorData.message) {
                        errorMsg = errorData.message;
                    }
                    
                    throw new Error(errorMsg);
                }

                showAlert('–ö–ª—ñ—î–Ω—Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!', 'success');
                loadClients();
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞: ' + error.message, 'error');
            }
        }

        // –í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        async function deleteOrder(orderId, orderNumber, clientName) {
            // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è–º
            const confirmMessage = `‚ö†Ô∏è –£–í–ê–ì–ê: –í–∏ –∑–±–∏—Ä–∞—î—Ç–µ—Å—è –ü–û–í–ù–Ü–°–¢–Æ –í–ò–î–ê–õ–ò–¢–ò –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!

üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è: ${orderNumber}
üë§ –ö–ª—ñ—î–Ω—Ç: ${clientName}

üö® –¶–Ø –î–Ü–Ø –ù–ï–ó–í–û–†–û–¢–ù–ê! üö®

–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤—Å—ñ –π–æ–≥–æ –ø–æ–∑–∏—Ü—ñ—ó –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –Ω–∞–∑–∞–≤–∂–¥–∏.
–ó–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ –ø–∞—Ä—Ç—ñ—ó –±—É–¥—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≤—ñ–ª—å–Ω–µ–Ω—ñ.

–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // –î–æ–¥–∞—Ç–∫–æ–≤–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
            if (!confirm(`–û—Å—Ç–∞–Ω–Ω—î –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è!\n\n–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ${orderNumber}?\n\n–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –û–ö –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        deleted_by: '–ü–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á',
                        reason: '–í–∏–¥–∞–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è';
                    
                    if (errorData.error) {
                        if (typeof errorData.error === 'string') {
                            errorMsg = errorData.error;
                        } else if (errorData.error.message) {
                            errorMsg = errorData.error.message;
                        } else if (errorData.error.details) {
                            errorMsg = errorData.error.details;
                        }
                    } else if (errorData.message) {
                        errorMsg = errorData.message;
                    }
                    
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                const deletedOrder = result.success && result.data ? result.data.deleted_order : null;
                
                showAlert(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ${orderNumber} –≤–∏–¥–∞–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!`, 'success');
                loadOrders(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å
                loadProducts(); // –û–Ω–æ–≤–ª—é—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤
                
                console.log('üóëÔ∏è –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ:', deletedOrder);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:', error);
                showAlert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: ' + error.message, 'error');
            }
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        function refreshPage() {
            loadClients();
            loadOrders();
            loadProducts(); // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ –ø–∞—Ä—Ç—ñ—ó
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥—Ä—É–∫—É HTML –≤–µ—Ä—Å—ñ—ó
        function printOrderPDF(orderId) {
            const printUrl = `${API_URL}/orders/${orderId}/preview`;
            const printWindow = window.open(printUrl, '_blank', 'width=1200,height=800');
            
            if (printWindow) {
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.focus();
                        printWindow.print();
                    }, 1000);
                };
            } else {
                window.open(printUrl, '_blank');
            }
        }

        // –î–æ–¥–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('focus', function() {
            if (typeof window.refreshPageContent === 'function') {
                window.refreshPageContent();
            } else if (typeof refreshPage === 'function') {
                refreshPage();
            }
        });

        // –î–æ–¥–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –º–æ–¥–∞–ª—å–Ω–∏–º–∏ –≤—ñ–∫–Ω–∞–º–∏
        function setupModalHandlers() {
            document.querySelectorAll('.modal-close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                    }
                });
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
        }
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–∫—Ä–∞—â–µ–Ω–æ—ó —Ñ–æ—Ä–º–∏ –∫–ª—ñ—î–Ω—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
    setupClientPreview();
    
    // –î–æ–¥–∞—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
    setupClientValidation();
    
    // –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
    setupPhoneFormatting();
});

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–ª—ñ—î–Ω—Ç–∞
function setupClientPreview() {
    const fields = ['client-name-modal', 'client-contact-person', 'client-phone', 'client-email', 'client-address'];
    const preview = document.getElementById('clientPreview');
    
    if (!preview) return;
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateClientPreview);
        }
    });
    
    updateClientPreview();
}

function updateClientPreview() {
    const preview = document.getElementById('clientPreview');
    if (!preview) return;
    
    preview.classList.add('preview-updating');
    
    setTimeout(() => {
        const name = document.getElementById('client-name-modal')?.value || '';
        const contact = document.getElementById('client-contact-person')?.value || '';
        const phone = document.getElementById('client-phone')?.value || '';
        const email = document.getElementById('client-email')?.value || '';
        const address = document.getElementById('client-address')?.value || '';
        
        if (!name && !contact && !phone && !email && !address) {
            preview.innerHTML = '<em style="color: #95a5a6;">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–ª—ñ—î–Ω—Ç–∞</em>';
        } else {
            let previewText = '';
            if (name) previewText += `üè¢ <strong>${name}</strong><br>`;
            if (contact) previewText += `üë§ –ö–æ–Ω—Ç–∞–∫—Ç: ${contact}<br>`;
            if (phone) previewText += `üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${phone}<br>`;
            if (email) previewText += `‚úâÔ∏è Email: ${email}<br>`;
            if (address) previewText += `üìç –ê–¥—Ä–µ—Å–∞: ${address}`;
            
            preview.innerHTML = previewText;
        }
        
        preview.classList.remove('preview-updating');
        preview.classList.add('preview-updated');
        
        setTimeout(() => {
            preview.classList.remove('preview-updated');
        }, 200);
    }, 100);
}

// –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Ñ–æ—Ä–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
function setupClientValidation() {
    const form = document.getElementById('client-form');
    if (!form) return;
    
    const nameField = document.getElementById('client-name-modal');
    const emailField = document.getElementById('client-email');
    const phoneField = document.getElementById('client-phone');
    
    if (nameField) {
        nameField.addEventListener('blur', function() {
            validateRequired(this);
        });
    }
    
    if (emailField) {
        emailField.addEventListener('blur', function() {
            validateEmail(this);
        });
    }
    
    if (phoneField) {
        phoneField.addEventListener('blur', function() {
            validatePhone(this);
        });
    }
}

function validateRequired(field) {
    const group = field.closest('.form-group');
    if (!group) return;
    
    if (field.value.trim()) {
        group.classList.remove('has-error');
        group.classList.add('has-success');
    } else {
        group.classList.remove('has-success');
        group.classList.add('has-error');
    }
}

function validateEmail(field) {
    const group = field.closest('.form-group');
    if (!group) return;
    
    if (!field.value) {
        group.classList.remove('has-error', 'has-success');
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (emailRegex.test(field.value)) {
        group.classList.remove('has-error');
        group.classList.add('has-success');
    } else {
        group.classList.remove('has-success');
        group.classList.add('has-error');
    }
}

function validatePhone(field) {
    const group = field.closest('.form-group');
    if (!group) return;
    
    if (!field.value) {
        group.classList.remove('has-error', 'has-success');
        return;
    }
    
    // –ë–∞–∑–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
    if (phoneRegex.test(field.value)) {
        group.classList.remove('has-error');
        group.classList.add('has-success');
    } else {
        group.classList.remove('has-success');
        group.classList.add('has-error');
    }
}

// –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
function setupPhoneFormatting() {
    const phoneField = document.getElementById('client-phone');
    if (!phoneField) return;
    
    phoneField.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, ''); // –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏
        
        if (value.startsWith('380')) {
            // –£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –Ω–æ–º–µ—Ä
            value = value.replace(/^380(\d{2})(\d{3})(\d{2})(\d{2})$/, '+380 $1 $2 $3 $4');
        } else if (value.length >= 10) {
            // –Ü–Ω—à–∏–π —Ñ–æ—Ä–º–∞—Ç
            value = value.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, '$1 $2 $3 $4');
        }
        
        this.value = value;
    });
}

// –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
function closeClientModal() {
    const modal = document.getElementById('client-modal');
    if (!modal) return;
    
    // –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–∞–∫—Ä–∏—Ç—Ç—è
    modal.classList.add('modal-closing');
    
    setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('modal-closing');
        
        // –û—á–∏—â–∞—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
        const form = document.getElementById('client-form');
        if (form) {
            form.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('has-error', 'has-success');
            });
        }
        
        // –°–∫–∏–¥–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
        updateClientPreview();
    }, 300);
    
    currentClientId = null;
    document.body.style.overflow = 'auto';
}

// –ü–µ—Ä–µ–≤–∏–∑–Ω–∞—á–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
function showNewClientForm() {
    currentClientId = null;
    document.getElementById('client-modal-title').innerHTML = '‚ûï –î–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞';
    
    const form = document.getElementById('client-form');
    if (form) {
        form.reset();
        // –û—á–∏—â–∞—î–º–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é
        form.querySelectorAll('.form-group').forEach(group => {
            group.classList.remove('has-error', 'has-success');
        });
    }
    
    document.getElementById('client-id').value = '';
    
    const modal = document.getElementById('client-modal');
    modal.style.display = 'block';
    modal.classList.add('modal-opening');
    
    // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è
    setTimeout(() => {
        modal.classList.remove('modal-opening');
    }, 300);
    
    document.body.style.overflow = 'hidden';
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä—à–æ–º—É –ø–æ–ª—ñ
    setTimeout(() => {
        const nameField = document.getElementById('client-name-modal');
        if (nameField) nameField.focus();
    }, 350);
    
    // –ü–µ—Ä–µ–Ω–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
    setupClientPreview();
}
        
    </script>
    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è - –¥–æ–¥–∞—Ç–∏ –¥–æ orders.html –ø—ñ—Å–ª—è —ñ—Å–Ω—É—é—á–∏—Ö –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω -->

<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
<div id="editOrderModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è <span id="editOrderNumber"></span></h2>
            <span class="modal-close">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editOrderForm">
                <!-- –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editClientName">–ö–ª—ñ—î–Ω—Ç *</label>
                        <input type="text" id="editClientName" name="client_name" required>
                    </div>
                    <div class="form-group">
                        <label for="editClientContact">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</label>
                        <textarea id="editClientContact" name="client_contact" rows="3" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editDeliveryDate">–î–∞—Ç–∞ –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
                        <input type="date" id="editDeliveryDate" name="delivery_date">
                    </div>
                    <div class="form-group">
                        <label for="editOrderStatus">–°—Ç–∞—Ç—É—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                        <select id="editOrderStatus" name="status">
                            <option value="NEW">–ù–æ–≤–µ</option>
                            <option value="CONFIRMED">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–µ</option>
                            <option value="IN_PRODUCTION">–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</option>
                            <option value="READY">–ì–æ—Ç–æ–≤–µ</option>
                            <option value="SHIPPED">–í—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–µ</option>
                            <option value="COMPLETED">–ó–∞–≤–µ—Ä—à–µ–Ω–µ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editOrderNotes">–ü—Ä–∏–º—ñ—Ç–∫–∏ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                    <textarea id="editOrderNotes" name="notes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..."></textarea>
                </div>

                <!-- –°–µ–∫—Ü—ñ—è —Ç–æ–≤–∞—Ä—ñ–≤ -->
                <div class="section-title" style="margin-top: 2rem;">üì¶ –¢–æ–≤–∞—Ä–∏ –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ</div>
                
                <div id="editOrderItems" class="order-items-edit">
                    <!-- –¢—É—Ç –±—É–¥—É—Ç—å –ø–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
                </div>
                
                <div style="margin: 1rem 0;">
                    <button type="button" id="addOrderItemBtn" class="btn btn-success">‚ûï –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                </div>

                <!-- –ü—ñ–¥—Å—É–º–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
                <div class="order-summary-edit" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 1rem 0;">
                    <h4>üìä –ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:</h4>
                    <div class="summary-row">
                        <span>–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å:</span>
                        <strong><span id="editOrderTotalQuantity">0</span> —à—Ç</strong>
                    </div>
                    <div class="summary-row">
                        <span>–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —è—â–∏–∫—ñ–≤:</span>
                        <strong><span id="editOrderTotalBoxes">0</span> —è—â</strong>
                    </div>
                    <div class="summary-row">
                        <span>–ü–æ–∑–∏—Ü—ñ–π –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ:</span>
                        <strong><span id="editOrderTotalItems">0</span></strong>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="submit" form="editOrderForm" class="btn btn-success">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
            <button type="button" class="btn btn-secondary" onclick="cancelEditOrder()">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å */
.modal-large {
    max-width: 1000px;
    width: 95%;
}

.order-items-edit {
    margin: 1rem 0;
}

.order-item-row {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.order-item-row:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}

.item-row-content {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 2fr 80px;
    gap: 1rem;
    align-items: end;
}

.order-item-row .form-group {
    margin-bottom: 0;
}

.order-item-row label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
}

.order-item-row input,
.order-item-row select {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
}

.order-item-row input:focus,
.order-item-row select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.boxes-display {
    background: #e9ecef !important;
    cursor: not-allowed;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.summary-row:last-child {
    margin-bottom: 0;
    padding-top: 0.5rem;
    border-top: 1px solid #dee2e6;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è */
@media (max-width: 768px) {
    .modal-large {
        width: 98%;
        max-width: none;
    }
    
    .item-row-content {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .order-item-row {
        padding: 0.75rem;
    }
    
    .summary-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
}

/* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
.order-item-row {
    animation: orderItemSlideIn 0.3s ease;
}

@keyframes orderItemSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.order-item-removing {
    animation: orderItemSlideOut 0.3s ease forwards;
}

@keyframes orderItemSlideOut {
    from {
        opacity: 1;
        transform: translateY(0);
        max-height: 200px;
    }
    to {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
}

/* –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó */
.order-item-row .form-group.has-error input,
.order-item-row .form-group.has-error select {
    border-color: #e74c3c;
    box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.1);
}

.order-item-row .form-group.has-success input,
.order-item-row .form-group.has-success select {
    border-color: #27ae60;
    box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
}

/* –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è */
.order-item-row .btn-danger {
    height: 38px;
    width: 38px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 1rem;
}

.order-item-row .btn-danger:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
}
</style>
<script src="js/order-edit.js"></script>
</body>
</html>
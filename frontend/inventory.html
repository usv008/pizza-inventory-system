<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ó–∞–ø–∞—Å–∞–º–∏ - Pizza Inventory</title>
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/forms.css">
    <link rel="stylesheet" href="/styles/tables.css">
    <link rel="stylesheet" href="/styles/buttons.css">
    <link rel="stylesheet" href="/styles/modals-tabs.css">
    <link rel="stylesheet" href="/styles/navigation.css">
    <link rel="stylesheet" href="/styles/batches.css">
    <link rel="stylesheet" href="styles/arrivals.css">
    <style>
/* –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–∞—Ä—Ç—ñ–π */
.batches-list {
    max-height: none !important;
    opacity: 1 !important;
    display: block !important;
    overflow: visible !important;
}

.batch-item {
    display: grid !important;
    grid-template-columns: 1fr auto !important;
    gap: 1rem !important;
    align-items: center !important;
    padding: 0.75rem !important;
    margin-bottom: 0.5rem !important;
    background: #f8f9fa !important;
    border-radius: 8px !important;
    border-left: 3px solid #28a745 !important;
}
</style>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
</head>
<body>
    <div class="container">
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-products">0</div>
                <div class="stat-label">–¢–æ–≤–∞—Ä—ñ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-pieces">0</div>
                <div class="stat-label">–®—Ç—É–∫ –∑–∞–≥–∞–ª–æ–º</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-boxes">0</div>
                <div class="stat-label">–Ø—â–∏–∫—ñ–≤ –∑–∞–≥–∞–ª–æ–º</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-batches">0</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'production')">üè≠ –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</button>
            <button class="tab" onclick="openTab(event, 'writeoff')">‚ùå –°–ø–∏—Å–∞–Ω–Ω—è</button>
            <button class="tab" onclick="openTab(event, 'arrivals')">üì• –ü—Ä–∏—Ö—ñ–¥</button>
            <button class="tab" onclick="openTab(event, 'movements')">üìã –Ü—Å—Ç–æ—Ä—ñ—è —Ä—É—Ö—ñ–≤</button>
            <button class="tab" onclick="openTab(event, 'batches')">üì¶ –ü–∞—Ä—Ç—ñ—ó</button>
            
        </div>

        <div id="production" class="tab-content active">
            <div class="section-title">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</div>
            
            <div class="form-hint">
                üí° –ü—Ä–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∞–±–æ –ø–æ–ø–æ–≤–Ω—é—î—Ç—å—Å—è –ø–∞—Ä—Ç—ñ—è —Ç–æ–≤–∞—Ä—É –∑ –¥–∞—Ç–æ—é –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞.
                –ü–∞—Ä—Ç—ñ—ó –≤—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å—Å—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ FIFO –≤—ñ–¥–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
            </div>
            
            <form id="production-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="prod-product">–¢–æ–≤–∞—Ä *</label>
                        <select id="prod-product" name="product_id" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prod-date">–î–∞—Ç–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞ *</label>
                        <input type="date" id="prod-date" name="production_date" required>
                    </div>
                    <div class="form-group">
                        <label for="prod-total">–ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (—à—Ç) *</label>
                        <input type="number" id="prod-total" name="total_quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="prod-boxes">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —è—â–∏–∫—ñ–≤</label>
                        <input type="number" id="prod-boxes" name="boxes_quantity" min="0" value="0" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="prod-pieces">–®—Ç—É–∫ –±–µ–∑ —è—â–∏–∫—ñ–≤</label>
                        <input type="number" id="prod-pieces" name="pieces_quantity" min="0" value="0" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="prod-responsible">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</label>
                        <input type="text" id="prod-responsible" name="responsible" placeholder="–Ü–º'—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ–≥–æ">
                    </div>
                </div>
                <div class="form-group">
                    <label for="prod-notes">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                    <textarea id="prod-notes" name="notes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..."></textarea>
                </div>
                <div class="form-group">
                    <label>–¢–µ—Ä–º—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è: <span id="expiry-date">–±—É–¥–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (+365 –¥–Ω—ñ–≤)</span></label>
                </div>
                
                <!-- –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —ñ—Å–Ω—É—é—á—É –ø–∞—Ä—Ç—ñ—é -->
                <div id="batch-warning" class="expiry-warning" style="display: none;">
                    ‚ÑπÔ∏è <span id="batch-warning-text"></span>
                </div>
                
                <button type="submit" class="btn btn-success">‚ûï –î–æ–¥–∞—Ç–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</button>
                <button type="button" class="btn" onclick="clearProductionForm()">üîÑ –û—á–∏—Å—Ç–∏—Ç–∏</button>
            </form>

            <div class="section-title" style="margin-top: 3rem;">–Ü—Å—Ç–æ—Ä—ñ—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</div>
            
            <div id="production-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div id="production-content" style="display: none;">
                <table class="table" id="production-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞/—á–∞—Å</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ó–∞–≥–∞–ª—å–Ω–∞ –∫-—Ç—å</th>
                            <th>–Ø—â–∏–∫—ñ–≤</th>
                            <th>–®—Ç—É–∫</th>
                            <th>–ü–∞—Ä—Ç—ñ—è</th>
                            <th>–ó–∞–ª–∏—à–∫–∏ –ø–∞—Ä—Ç—ñ—ó</th>
                            <th>–¢–µ—Ä–º—ñ–Ω –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è</th>
                            <th>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</th>
                        </tr>
                    </thead>
                    <tbody id="production-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="writeoff" class="tab-content">
            <div class="section-title">–°–ø–∏—Å–∞—Ç–∏ —Ç–æ–≤–∞—Ä</div>
            
            <div class="form-hint">
                üí° –û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä —ñ –ø–∞—Ä—Ç—ñ—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è. –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è —Å–ø–∏—Å—É–≤–∞—Ç–∏ –∑ –Ω–∞–π—Å—Ç–∞—Ä—ñ—à–∏—Ö –ø–∞—Ä—Ç—ñ–π (FIFO).
            </div>
            
            <form id="writeoff-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="wo-product">–¢–æ–≤–∞—Ä *</label>
                        <select id="wo-product" name="product_id" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wo-batch">–ü–∞—Ä—Ç—ñ—è –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è</label>
                        <select id="wo-batch" name="batch_id" style="display: none;">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä—Ç—ñ—é...</option>
                        </select>
                        <div id="wo-batch-info" class="batches-loading" style="display: none;">
                            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π...
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="wo-date">–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–Ω—è *</label>
                        <input type="date" id="wo-date" name="writeoff_date" required>
                    </div>
                    <div class="form-group">
                        <label for="wo-total">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è (—à—Ç) *</label>
                        <input type="number" id="wo-total" name="total_quantity" min="1" required>
                        <small id="wo-available" style="color: #7f8c8d; display: block; margin-top: 0.25rem;"></small>
                    </div>
                    <div class="form-group">
                        <label for="wo-reason">–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–Ω—è *</label>
                        <select id="wo-reason" name="reason" required>
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É...</option>
                            <option value="–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ">–ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ç–µ—Ä–º—ñ–Ω—É –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ</option>
                            <option value="–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è —É–ø–∞–∫–æ–≤–∫–∏">–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è —É–ø–∞–∫–æ–≤–∫–∏</option>
                            <option value="–ë—Ä–∞–∫ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞">–ë—Ä–∞–∫ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</option>
                            <option value="–í—Ç—Ä–∞—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É">–í—Ç—Ä–∞—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É</option>
                            <option value="–ü—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏—Ü—å–∫—ñ –≤–∏—Ç—Ä–∞—Ç–∏">–ü—Ä–µ–¥—Å—Ç–∞–≤–Ω–∏—Ü—å–∫—ñ –≤–∏—Ç—Ä–∞—Ç–∏</option>
                            <option value="–î–µ–≥—É—Å—Ç–∞—Ü—ñ—è">–î–µ–≥—É—Å—Ç–∞—Ü—ñ—è</option>
                            <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wo-responsible">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π *</label>
                        <input type="text" id="wo-responsible" name="responsible" required placeholder="–Ü–º'—è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ–≥–æ">
                    </div>
                </div>
                <div class="form-group">
                    <label for="wo-notes">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                    <textarea id="wo-notes" name="notes" rows="3" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–ø–∏—Å–∞–Ω–Ω—è..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-danger">‚ùå –°–ø–∏—Å–∞—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                <button type="button" class="btn" onclick="clearWriteoffForm()">üîÑ –û—á–∏—Å—Ç–∏—Ç–∏</button>
            </form>

            <div class="section-title" style="margin-top: 3rem;">–Ü—Å—Ç–æ—Ä—ñ—è —Å–ø–∏—Å–∞–Ω–Ω—è</div>
            
            <div id="writeoff-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div id="writeoff-content" style="display: none;">
                <table class="table" id="writeoff-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ü–∞—Ä—Ç—ñ—è</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</th>
                            <th>–ü—Ä–∏–º—ñ—Ç–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody id="writeoff-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="movements" class="tab-content">
            <div class="section-title">–Ü—Å—Ç–æ—Ä—ñ—è —Ä—É—Ö—ñ–≤ —Ç–æ–≤–∞—Ä—ñ–≤</div>
            
            <div class="form-grid" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="filter-product">–§—ñ–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É</label>
                    <select id="filter-product">
                        <option value="">–í—Å—ñ —Ç–æ–≤–∞—Ä–∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-type">–¢–∏–ø —Ä—É—Ö—É</label>
                    <select id="filter-type">
                        <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                        <option value="PRODUCTION">–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</option>
                        <option value="WRITEOFF">–°–ø–∏—Å–∞–Ω–Ω—è</option>
                        <option value="ADJUSTMENT">–ö–æ—Ä–µ–≥—É–≤–∞–Ω–Ω—è</option>
                        <option value="IN">–ü—Ä–∏—Ö—ñ–¥</option>
                        <option value="OUT">–í–∏—Ç—Ä–∞—Ç–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-batch">–§—ñ–ª—å—Ç—Ä –ø–æ –ø–∞—Ä—Ç—ñ—ó</label>
                    <input type="date" id="filter-batch" placeholder="–î–∞—Ç–∞ –ø–∞—Ä—Ç—ñ—ó">
                </div>
                <div class="form-group">
                    <label for="filter-date-from">–î–∞—Ç–∞ –≤—ñ–¥</label>
                    <input type="date" id="filter-date-from">
                </div>
                <div class="form-group">
                    <label for="filter-date-to">–î–∞—Ç–∞ –¥–æ</label>
                    <input type="date" id="filter-date-to">
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <button class="btn" onclick="applyMovementsFilter()">üîç –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="btn" onclick="clearMovementsFilter()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="btn" onclick="exportMovements()">üìä –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
            </div>
            
            <div id="movements-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div id="movements-content" style="display: none;">
                <div id="movements-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <strong>–ü—ñ–¥—Å—É–º–æ–∫:</strong>
                    <span id="movements-count">0</span> –∑–∞–ø–∏—Å—ñ–≤, 
                    –ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏—Ö—ñ–¥: <span id="total-in" style="color: #27ae60;">+0 —à—Ç</span>, 
                    –ó–∞–≥–∞–ª—å–Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∞: <span id="total-out" style="color: #e74c3c;">-0 —à—Ç</span>
                </div>
                
                <table class="table" id="movements-table">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ü–∞—Ä—Ç—ñ—è</th>
                            <th>–¢–∏–ø —Ä—É—Ö—É</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞/–û–ø–∏—Å</th>
                            <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="batches" class="tab-content">
            <div class="section-title">–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–∞—Ä—Ç—ñ—è–º–∏</div>
            
            <div class="form-grid" style="margin-bottom: 2rem;">
                <div class="form-group">
                    <label for="batch-filter-product">–¢–æ–≤–∞—Ä</label>
                    <select id="batch-filter-product">
                        <option value="">–í—Å—ñ —Ç–æ–≤–∞—Ä–∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="batch-filter-status">–°—Ç–∞—Ç—É—Å</label>
                    <select id="batch-filter-status">
                        <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                        <option value="ACTIVE">–ê–∫—Ç–∏–≤–Ω—ñ</option>
                        <option value="EXPIRING">–ó–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è</option>
                        <option value="EXPIRED">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</option>
                        <option value="DEPLETED">–í–∏—á–µ—Ä–ø–∞–Ω—ñ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="batch-filter-days">–î–Ω—ñ–≤ –¥–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è</label>
                    <select id="batch-filter-days">
                        <option value="">–í—Å—ñ</option>
                        <option value="1">1 –¥–µ–Ω—å</option>
                        <option value="3">3 –¥–Ω—ñ</option>
                        <option value="7">7 –¥–Ω—ñ–≤</option>
                        <option value="30">30 –¥–Ω—ñ–≤</option>
                        <option value="90">90 –¥–Ω—ñ–≤</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <button class="btn" onclick="loadBatchesWithFilter()">üîç –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="btn" onclick="clearBatchesFilter()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                <button class="btn btn-warning" onclick="loadExpiringBatches()">‚ö†Ô∏è –©–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è</button>
            </div>
            
            <div id="batches-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π...</div>
            <div id="batches-content" style="display: none;">
                <div id="batches-summary" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <strong>–ü—ñ–¥—Å—É–º–æ–∫ –ø–∞—Ä—Ç—ñ–π:</strong>
                    <span id="batches-total-count">0</span> –ø–∞—Ä—Ç—ñ–π, 
                    <span id="batches-total-quantity">0 —à—Ç</span> –∑–∞–≥–∞–ª–æ–º
                </div>
                
                <div id="batches-grid" class="pizzas-grid">
                    <!-- –¢—É—Ç –±—É–¥—É—Ç—å –∫–∞—Ä—Ç–∫–∏ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏ -->
                </div>
            </div>
        </div>

        <div id="arrivals" class="tab-content">
            <div class="arrival-form-header">
                <h2 class="arrival-form-title">
                    üì¶ –î–æ–∫—É–º–µ–Ω—Ç –û–ø—Ä–∏—Ö–æ–¥—É–≤–∞–Ω–Ω—è
                </h2>
                <p class="arrival-form-subtitle">–î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ —â–æ –Ω–∞–¥—ñ–π—à–ª–∏ –Ω–∞ —Å–∫–ª–∞–¥</p>
            </div>
        
            <form id="arrival-form">
                <div class="arrival-main-fields">
                    <div class="arrival-field-group">
                        <label for="arrival-date">–î–∞—Ç–∞ –ø—Ä–∏—Ö–æ–¥—É *</label>
                        <input type="date" id="arrival-date" name="arrival_date" required>
                    </div>
                    <div class="arrival-field-group">
                        <label for="arrival-reason">–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–∏—Ö–æ–¥—É *</label>
                        <input type="text" id="arrival-reason" name="reason" required 
                               placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞, –Ω–∞–¥–ª–∏—à–∫–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞...">
                    </div>
                </div>
        
                <div class="arrival-items-section">
                    <div class="arrival-items-header">
                        <h3 class="arrival-items-title">
                            üõí –ü–æ–∑–∏—Ü—ñ—ó –¥–æ–∫—É–º–µ–Ω—Ç—É
                        </h3>
                        <button type="button" id="add-arrival-item" class="add-item-btn">
                            ‚ûï –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é
                        </button>
                    </div>
        
                    <div class="arrival-items-container">
                        <table id="arrival-items-table">
                            <thead>
                                <tr>
                                    <th>–¢–æ–≤–∞—Ä *</th>
                                    <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å *</th>
                                    <th>–î–∞—Ç–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞ *</th>
                                    <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="arrival-items-empty">
                                    <td colspan="5">
                                        –î–æ–¥–∞–π—Ç–µ –ø–æ–∑–∏—Ü—ñ—ó –¥–æ –¥–æ–∫—É–º–µ–Ω—Ç—É<br>
                                        <small style="color: #adb5bd;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é" —â–æ–± –ø–æ—á–∞—Ç–∏</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
        
                <div class="arrival-form-actions">
                    <button type="submit" class="arrival-submit-btn">
                        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥—É
                    </button>
                </div>
            </form>
        
            <div id="arrival-success" style="display:none;"></div>
            <div id="arrival-error" style="display:none;"></div>
        </div>
    </div>

    <script src="/js/error-handler.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="js/arrival.js"></script>
    <script>
        // –ë–∞–∑–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ —Ç–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó
        if (!window.safeQuerySelectorAll) {
            window.safeQuerySelectorAll = window.errorHandler.safeQuerySelectorAll.bind(window.errorHandler);
        }
        if (!window.logError) {
            window.logError = window.errorHandler.logError.bind(window.errorHandler);
        }
        if (!window.showUserError) {
            window.showUserError = window.errorHandler.showUserError.bind(window.errorHandler);
        }
        if (!window.safeQuerySelector) {
            window.safeQuerySelector = window.errorHandler.safeQuerySelector.bind(window.errorHandler);
        }
        
        const API_URL = 'http://localhost:3000/api';
        let products = [];
        let productBatches = {}; // –ö–µ—à –ø–∞—Ä—Ç—ñ–π –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', async function() {
            // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è authManager
            if (typeof authManager === 'undefined') {
                console.log('Waiting for authManager...');
                setTimeout(async () => {
                    const isAuthenticated = await authManager.requireAuth();
                    if (isAuthenticated) {
                        initializePage();
                    }
                }, 100);
            } else {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
                const isAuthenticated = await authManager.requireAuth();
                if (isAuthenticated) {
                    initializePage();
                }
            }
        });

        async function initializePage() {
            try {
                await loadProducts();
                setupDateFields();
                setupEventListeners();
                
                await Promise.all([
                    loadStats(),
                    loadProduction(),
                    loadWriteoffs(),
                    loadMovements()
                ]);
            } catch (error) {
                logError('Failed to initialize inventory page', 'PAGE_INIT_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏');
            }
            populateBatchProductFilter();
        }

        function setupDateFields() {
            const today = new Date().toISOString().split('T')[0];
            
            const prodDate = safeQuerySelector('#prod-date');
            if (prodDate) prodDate.value = today;
            
            const woDate = safeQuerySelector('#wo-date');
            if (woDate) woDate.value = today;
        }

        function setupEventListeners() {
            const prodDate = safeQuerySelector('#prod-date');
            if (prodDate) {
                prodDate.addEventListener('change', function() {
                    updateExpiryDate();
                    checkExistingBatch();
                });
                updateExpiryDate();
            }
            
            setupProductEventListeners();
            setupFormHandlers();
            initializeTabs();
        }

        function setupProductEventListeners() {
            const prodProduct = safeQuerySelector('#prod-product');
            const prodTotal = safeQuerySelector('#prod-total');
            
            if (prodProduct && prodTotal) {
                prodProduct.addEventListener('change', function() {
                    calculateQuantities();
                    checkExistingBatch();
                });
                prodTotal.addEventListener('input', calculateQuantities);
            }
            
            const woProduct = safeQuerySelector('#wo-product');
            if (woProduct) {
                woProduct.addEventListener('change', function() {
                    loadProductBatches(this.value);
                });
            }
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É—é—á–æ—ó –ø–∞—Ä—Ç—ñ—ó –ø—Ä–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ
        async function checkExistingBatch() {
            const productId = safeQuerySelector('#prod-product')?.value;
            const productionDate = safeQuerySelector('#prod-date')?.value;
            const warningDiv = safeQuerySelector('#batch-warning');
            const warningText = safeQuerySelector('#batch-warning-text');
            
            if (!productId || !productionDate || !warningDiv || !warningText) {
                if (warningDiv) warningDiv.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/products/${productId}/batches`);
                if (response.ok) {
                    const batches = await response.json();
                    const existingBatch = batches.find(b => b.batch_date === productionDate);
                    
                    if (existingBatch) {
                        warningText.textContent = `–ü–∞—Ä—Ç—ñ—è –Ω–∞ —Ü—é –¥–∞—Ç—É –≤–∂–µ —ñ—Å–Ω—É—î (${existingBatch.available_quantity} —à—Ç). –ù–æ–≤–µ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ –±—É–¥–µ –¥–æ–¥–∞–Ω–æ –¥–æ —ñ—Å–Ω—É—é—á–æ—ó –ø–∞—Ä—Ç—ñ—ó.`;
                        warningDiv.style.display = 'block';
                        warningDiv.className = 'expiry-warning'; // –ó–≤–∏—á–∞–π–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
                    } else {
                        warningText.textContent = '–ë—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–∞ –Ω–æ–≤–∞ –ø–∞—Ä—Ç—ñ—è –Ω–∞ —Ü—é –¥–∞—Ç—É.';
                        warningDiv.style.display = 'block';
                        warningDiv.className = 'expiry-warning'; // –ó–≤–∏—á–∞–π–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
                    }
                }
            } catch (error) {
                logError('Failed to check existing batch', 'BATCH_CHECK_ERROR', error);
                if (warningDiv) warningDiv.style.display = 'none';
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π –¥–ª—è —Ç–æ–≤–∞—Ä—É (–¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è)
        async function loadProductBatches(productId) {
            const batchSelect = safeQuerySelector('#wo-batch');
            const batchInfo = safeQuerySelector('#wo-batch-info');
            const availableDiv = safeQuerySelector('#wo-available');
            
            if (!productId) {
                if (batchSelect) {
                    batchSelect.style.display = 'none';
                    batchSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä—Ç—ñ—é...</option>';
                }
                if (batchInfo) batchInfo.style.display = 'none';
                if (availableDiv) availableDiv.textContent = '';
                return;
            }
            
            try {
                if (batchInfo) {
                    batchInfo.style.display = 'block';
                    batchInfo.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π...';
                }
                
                // –í–ò–ü–†–ê–í–õ–ï–ù–û: –¥–æ–¥–∞—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä includeExpired=true —â–æ–± –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ñ –ø–∞—Ä—Ç—ñ—ó –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è
                const response = await fetch(`${API_URL}/products/${productId}/batches?includeExpired=true`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π');
                
                const batches = await response.json();
                // –í–ò–ü–†–ê–í–õ–ï–ù–û: –ø–æ–∫–∞–∑—É—î–º–æ –í–°–Ü –ø–∞—Ä—Ç—ñ—ó –∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é > 0, –≤–∫–ª—é—á–∞—é—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ñ
                const activeBatches = batches.filter(b => b.available_quantity > 0);
                
                if (batchSelect) {
                    batchSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä—Ç—ñ—é...</option>';
                    
                    // –°–æ—Ä—Ç—É—î–º–æ –ø–∞—Ä—Ç—ñ—ó: —Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ, –ø–æ—Ç—ñ–º —â–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è, –ø–æ—Ç—ñ–º –∞–∫—Ç–∏–≤–Ω—ñ
                    activeBatches.sort((a, b) => {
                        if (a.is_expired && !b.is_expired) return -1;
                        if (!a.is_expired && b.is_expired) return 1;
                        if (a.is_expiring && !b.is_expiring) return -1;
                        if (!a.is_expiring && b.is_expiring) return 1;
                        return new Date(a.batch_date) - new Date(b.batch_date);
                    });
                    
                    activeBatches.forEach(batch => {
                        const option = document.createElement('option');
                        option.value = batch.id;
                        const batchDate = new Date(batch.batch_date).toLocaleDateString('uk-UA');
                        
                        // –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –æ–ø—Ü—ñ—ó –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å—Ç–∞—Ç—É—Å—É
                        if (batch.is_expired || batch.days_to_expiry <= 0) {
                            option.textContent = `${batchDate} - ${batch.available_quantity} —à—Ç ‚ùå –ü–†–û–°–¢–†–û–ß–ï–ù–ê`;
                            option.style.color = '#e74c3c';
                            option.style.fontWeight = 'bold';
                        } else if (batch.is_expiring || batch.days_to_expiry <= 7) {
                            option.textContent = `${batchDate} - ${batch.available_quantity} —à—Ç ‚ö†Ô∏è ${Math.ceil(batch.days_to_expiry)} –¥–Ω.`;
                            option.style.color = '#f39c12';
                            option.style.fontWeight = 'bold';
                        } else {
                            option.textContent = `${batchDate} - ${batch.available_quantity} —à—Ç ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞`;
                            option.style.color = '#27ae60';
                        }
                        
                        option.setAttribute('data-available', batch.available_quantity);
                        option.setAttribute('data-status', batch.batch_status || (batch.is_expired ? 'EXPIRED' : batch.is_expiring ? 'EXPIRING' : 'ACTIVE'));
                        
                        batchSelect.appendChild(option);
                    });
                    
                    batchSelect.style.display = 'block';
                    
                    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤–∏–±–æ—Ä—É –ø–∞—Ä—Ç—ñ—ó
                    batchSelect.addEventListener('change', function() {
                        const selectedOption = this.selectedOptions[0];
                        if (selectedOption && availableDiv) {
                            const available = selectedOption.getAttribute('data-available');
                            availableDiv.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –≤ –ø–∞—Ä—Ç—ñ—ó: ${available} —à—Ç`;
                            availableDiv.style.color = '#27ae60';
                        } else if (availableDiv) {
                            availableDiv.textContent = '';
                        }
                    });
                }
                
                if (batchInfo) {
                    if (activeBatches.length === 0) {
                        batchInfo.textContent = '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è';
                        batchInfo.style.color = '#e74c3c';
                    } else {
                        batchInfo.style.display = 'none';
                    }
                }
                
                // –ö–µ—à—É—î–º–æ –ø–∞—Ä—Ç—ñ—ó
                productBatches[productId] = batches;
                
            } catch (error) {
                logError('Failed to load product batches', 'BATCH_LOAD_ERROR', error);
                if (batchInfo) {
                    batchInfo.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π';
                    batchInfo.style.color = '#e74c3c';
                }
            }
        }

        function setupFormHandlers() {
            // –û–±—Ä–æ–±–Ω–∏–∫ —Ñ–æ—Ä–º–∏ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞
            const productionForm = safeQuerySelector('#production-form');
            if (productionForm) {
                productionForm.addEventListener('submit', handleProductionSubmit);
            }
            
            // –û–±—Ä–æ–±–Ω–∏–∫ —Ñ–æ—Ä–º–∏ —Å–ø–∏—Å–∞–Ω–Ω—è
            const writeoffForm = safeQuerySelector('#writeoff-form');
            if (writeoffForm) {
                writeoffForm.addEventListener('submit', handleWriteoffSubmit);
            }
        }

        async function handleProductionSubmit(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const productionData = Object.fromEntries(formData.entries());
                
                // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
                if (!productionData.product_id) {
                    showUserError('–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä –¥–ª—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞');
                    return;
                }
                
                if (!productionData.production_date) {
                    showUserError('–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞');
                    return;
                }
                
                const totalQuantity = parseInt(productionData.total_quantity);
                if (isNaN(totalQuantity) || totalQuantity <= 0) {
                    showUserError('–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—î –±—É—Ç–∏ –¥–æ–¥–∞—Ç–Ω–∏–º —á–∏—Å–ª–æ–º');
                    return;
                }
                
                productionData.total_quantity = totalQuantity;
                productionData.product_id = parseInt(productionData.product_id);

                const response = await fetch(`${API_URL}/production`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(productionData)
                });

                if (!response.ok) {
                    let errorMessage = '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞';
                    
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const errorData = await response.json();
                            // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                            if (errorData.error) {
                                if (typeof errorData.error === 'string') {
                                    errorMessage = errorData.error;
                                } else if (errorData.error.message) {
                                    errorMessage = errorData.error.message;
                                } else if (errorData.error.details) {
                                    errorMessage = errorData.error.details;
                                }
                            } else if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } else {
                            errorMessage = `–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`;
                        }
                    } catch (parseError) {
                        errorMessage = `–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                const productionResult = result.success ? result.data : result;
                showUserError(`–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ –¥–æ–¥–∞–Ω–æ! –ü–∞—Ä—Ç—ñ—è: ${productionResult.batch_date || productionData.production_date}`, 'success');
                clearProductionForm();
                await Promise.all([loadProduction(), loadStats()]);
                
            } catch (error) {
                logError('Failed to create production', 'PRODUCTION_CREATE_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞: ' + error.message);
            }
        }

        async function handleWriteoffSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const writeoffData = Object.fromEntries(formData.entries());
            
            // –í–∞–ª—ñ–¥–∞—Ü—ñ—è
            if (!writeoffData.product_id || !writeoffData.total_quantity || 
                !writeoffData.reason || !writeoffData.responsible) {
                showUserError('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
                return;
            }
            
            // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–∞ –ø–∞—Ä—Ç—ñ—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ API —Å–ø–∏—Å–∞–Ω–Ω—è –ø–∞—Ä—Ç—ñ—ó
            if (writeoffData.batch_id) {
                try {
                    const response = await fetch(`${API_URL}/batches/${writeoffData.batch_id}/writeoff`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            quantity: parseInt(writeoffData.total_quantity),
                            reason: writeoffData.reason,
                            responsible: writeoffData.responsible,
                            notes: writeoffData.notes
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '–ü–æ–º–∏–ª–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è –ø–∞—Ä—Ç—ñ—ó');
                    }

                    showUserError('–ü–∞—Ä—Ç—ñ—é —É—Å–ø—ñ—à–Ω–æ —Å–ø–∏—Å–∞–Ω–æ!', 'success');
                    clearWriteoffForm();
                    await Promise.all([loadWriteoffs(), loadStats(), loadProducts()]);
                } catch (error) {
                    logError('Failed to writeoff batch', 'BATCH_WRITEOFF_ERROR', error);
                    showUserError('–ü–æ–º–∏–ª–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è –ø–∞—Ä—Ç—ñ—ó: ' + error.message);
                }
            } else {
                // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ —Å–ø–∏—Å–∞–Ω–Ω—è –±–µ–∑ –ø–∞—Ä—Ç—ñ—ó
                try {
                    const response = await fetch(`${API_URL}/writeoffs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(writeoffData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '–ü–æ–º–∏–ª–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É');
                    }

                    showUserError('–¢–æ–≤–∞—Ä —É—Å–ø—ñ—à–Ω–æ —Å–ø–∏—Å–∞–Ω–æ!', 'success');
                    clearWriteoffForm();
                    await Promise.all([loadWriteoffs(), loadStats(), loadProducts()]);
                } catch (error) {
                    logError('Failed to create writeoff', 'WRITEOFF_CREATE_ERROR', error);
                    showUserError('–ü–æ–º–∏–ª–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: ' + error.message);
                }
            }
        }

        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∫–ª–∞–¥–∫–∞–º–∏
        function openTab(event, tabName) {
            console.log('Opening tab:', tabName); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –≤–∫–ª–∞–¥–∫–∏
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(tc => {
                tc.classList.remove('active');
                tc.style.display = 'none';
            });
            // –í–∏–¥–∞–ª—è—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å –∑ —É—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫ –≤–∫–ª–∞–¥–æ–∫
            const allTabs = document.querySelectorAll('.tab');
            allTabs.forEach(t => t.classList.remove('active'));
            // –ü–æ–∫–∞–∑—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –≤–∫–ª–∞–¥–∫—É
            const activeContent = document.getElementById(tabName);
            if (activeContent) {
                activeContent.classList.add('active');
                activeContent.style.display = 'block';
                console.log('Tab content found and shown:', tabName);
            } else {
                console.error('Tab content not found:', tabName);
            }
            // –î–æ–¥–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó –∫–Ω–æ–ø–∫–∏
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            // –í–∏–∫–ª–∏–∫–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –≤–∫–ª–∞–¥–∫–∏ —è–∫—â–æ —ñ—Å–Ω—É—î
            if (window._tabHandlers && window._tabHandlers[tabName]) {
                try {
                    window._tabHandlers[tabName]();
                } catch (error) {
                    console.error('Tab handler error:', error);
                }
            }
        }

        function initializeTabs() {
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à—É –≤–∫–ª–∞–¥–∫—É (–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ) –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            const defaultTab = 'production';
            const defaultTabContent = document.getElementById(defaultTab);
            const defaultTabButton = document.querySelector('.tab[onclick*="production"]');
            if (defaultTabContent && defaultTabButton) {
                document.querySelectorAll('.tab-content').forEach(tc => {
                    tc.classList.remove('active');
                    tc.style.display = 'none';
                });
                defaultTabContent.classList.add('active');
                defaultTabContent.style.display = 'block';
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                defaultTabButton.classList.add('active');
                console.log('Default tab initialized:', defaultTab);
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤');
                
                const result = await response.json();
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π API —Ñ–æ—Ä–º–∞—Ç {success: true, data: [...]}
                products = result.success ? result.data : result;
                updateProductSelects();
                populateBatchProductFilter();
                
            } catch (error) {
                logError('Failed to load products', 'PRODUCTS_LOAD_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤: ' + error.message);
            }
        }

        function updateProductSelects() {
            const selects = [
                { id: 'prod-product', defaultText: '–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...' },
                { id: 'wo-product', defaultText: '–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä...', includeStock: true },
                { id: 'filter-product', defaultText: '–í—Å—ñ —Ç–æ–≤–∞—Ä–∏' },
                { id: 'batch-filter-product', defaultText: '–í—Å—ñ —Ç–æ–≤–∞—Ä–∏' }
            ];
            
            selects.forEach(selectConfig => {
                const select = safeQuerySelector(`#${selectConfig.id}`);
                if (!select) return;
                
                select.innerHTML = `<option value="">${selectConfig.defaultText}</option>`;
                
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.code})`;
                    
                    if (selectConfig.includeStock) {
                        option.setAttribute('data-stock', product.stock_pieces);
                        option.setAttribute('data-pieces-per-box', product.pieces_per_box);
                    }
                    
                    select.appendChild(option);
                });
            });
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑ –ø–∞—Ä—Ç—ñ–π–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏ (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ)
        async function loadStats() {
            try {
                const [statsResponse, batchesResponse] = await Promise.all([
                    fetch(`${API_URL}/stats`),
                    fetch(`${API_URL}/batches/grouped`)
                ]);
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±–∞–∑–æ–≤—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—ñ–≤
                let totalProducts = 0;
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    totalProducts = stats.total_products || 0;
                }
                
                // –û–±—á–∏—Å–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑ –ø–∞—Ä—Ç—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö (–±—ñ–ª—å—à —Ç–æ—á–Ω–æ)
                let totalStock = 0;
                let totalBoxes = 0;
                let totalBatches = 0;
                
                                 if (batchesResponse.ok) {
                     const batchesData = await batchesResponse.json();
                     // –û–±—Ä–æ–±–ª—è—î–º–æ null –∑–Ω–∞—á–µ–Ω–Ω—è - –∫–æ–ª–∏ —Ç–æ–≤–∞—Ä –±–µ–∑ –ø–∞—Ä—Ç—ñ–π
                     totalStock = batchesData.reduce((sum, p) => {
                         const available = p.available_quantity !== null && p.available_quantity !== undefined ? p.available_quantity : 0;
                         return sum + available;
                     }, 0);
                     totalBoxes = batchesData.reduce((sum, p) => {
                         const boxes = Math.floor((p.available_quantity || 0) / (p.pieces_per_box || 1));
                         return sum + boxes;
                     }, 0);
                     totalBatches = batchesData.reduce((sum, p) => sum + (p.batches_count || 0), 0);
                    
                    // –Ø–∫—â–æ –Ω–µ –æ—Ç—Ä–∏–º–∞–ª–∏ –±–∞–∑–æ–≤—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Ä–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤
                    if (!totalProducts) {
                        totalProducts = batchesData.length;
                    }
                }
                
                const statsElements = {
                    'total-products': totalProducts,
                    'total-pieces': totalStock,
                    'total-boxes': totalBoxes,
                    'total-batches': totalBatches
                };

                Object.entries(statsElements).forEach(([id, value]) => {
                    const element = safeQuerySelector(`#${id}`);
                    if (element) element.textContent = value;
                });
                
            } catch (error) {
                logError('Failed to load stats', 'STATS_LOAD_ERROR', error);
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏
        async function loadProduction() {
            const loadingEl = safeQuerySelector('#production-loading');
            const contentEl = safeQuerySelector('#production-content');
            
            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';

                const response = await fetch(`${API_URL}/production`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞');
                
                const result = await response.json();
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                const production = result.success ? result.data : result;
                displayProduction(production);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'block';
            } catch (error) {
                logError('Failed to load production', 'PRODUCTION_LOAD_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞: ' + error.message);
            }
        }

        function displayProduction(production) {
            const tbody = safeQuerySelector('#production-tbody');
            if (!tbody) {
                logError('Production table body not found', 'DOM_ERROR');
                return;
            }

            tbody.innerHTML = '';

            if (production.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #7f8c8d;">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</td></tr>';
                return;
            }

            production.forEach(item => {
                const row = document.createElement('tr');
                const dateStr = new Date(item.production_date).toLocaleDateString('uk-UA');
                const timeStr = item.production_time || '';
                const dateTime = timeStr ? `${dateStr}, ${timeStr}` : dateStr;
                const expiryDate = new Date(item.expiry_date).toLocaleDateString('uk-UA');
                
                // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∞—Ä—Ç—ñ—é - –í–ò–ü–†–ê–í–õ–ï–ù–û –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π
                const batchInfo = item.production_date ? 
                    `<span class="batch-status active">${new Date(item.production_date).toLocaleDateString('uk-UA')}</span>` : 
                    '<span style="color: #7f8c8d;">-</span>';
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑ –ø–∞—Ä—Ç—ñ—ó - —è–∫—â–æ —î batch_available_quantity –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –π–æ–≥–æ, —ñ–Ω–∞–∫—à–µ –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å
                const batchAvailable = item.batch_available_quantity !== undefined ? 
                    `${item.batch_available_quantity} —à—Ç` : 
                    item.batch_id ? `${item.total_quantity} —à—Ç` : '<span style="color: #7f8c8d;">-</span>';
                
                row.innerHTML = `
                    <td>${dateTime}</td>
                    <td>${item.product_name} (${item.product_code})</td>
                    <td>${item.total_quantity} —à—Ç</td>
                    <td>${item.boxes_quantity}</td>
                    <td>${item.pieces_quantity}</td>
                    <td>${batchInfo}</td>
                    <td>${batchAvailable}</td>
                    <td>${expiryDate}</td>
                    <td>${item.responsible || 'system'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —è—â–∏–∫—ñ–≤ —Ç–∞ —à—Ç—É–∫
        function calculateQuantities() {
            const productId = safeQuerySelector('#prod-product')?.value;
            const totalQuantity = parseInt(safeQuerySelector('#prod-total')?.value) || 0;
            
            const boxesEl = safeQuerySelector('#prod-boxes');
            const piecesEl = safeQuerySelector('#prod-pieces');
            
            if (!productId || !totalQuantity || !boxesEl || !piecesEl) {
                if (boxesEl) boxesEl.value = 0;
                if (piecesEl) piecesEl.value = 0;
                removeQuantityHint();
                return;
            }
            
            const selectedProduct = products.find(p => p.id == productId);
            if (!selectedProduct) return;
            
            const piecesPerBox = selectedProduct.pieces_per_box;
            const boxes = Math.floor(totalQuantity / piecesPerBox);
            const remainingPieces = totalQuantity % piecesPerBox;
            
            boxesEl.value = boxes;
            piecesEl.value = remainingPieces;
            
            showQuantityHint(totalQuantity, boxes, piecesPerBox, remainingPieces);
        }

        function showQuantityHint(total, boxes, piecesPerBox, pieces) {
            // –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π hint —è–∫—â–æ —î
            removeQuantityHint();
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π hint
            const hint = document.createElement('small');
            hint.id = 'quantity-hint';
            hint.style.cssText = 'color: #7f8c8d; display: block; margin-top: 0.25rem;';
            hint.textContent = `${boxes} —è—â + ${pieces} —à—Ç (–ø–æ ${piecesPerBox} –≤ —è—â.)`;
            
            const totalInput = safeQuerySelector('#prod-total');
            if (totalInput && totalInput.parentNode) {
                totalInput.parentNode.appendChild(hint);
            }
        }

        function removeQuantityHint() {
            const hint = safeQuerySelector('#quantity-hint');
            if (hint && hint.parentNode) {
                try {
                    hint.parentNode.removeChild(hint);
                } catch (error) {
                    // –ï–ª–µ–º–µ–Ω—Ç –≤–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ –∞–±–æ –Ω–µ —ñ—Å–Ω—É—î
                    console.log('Quantity hint already removed or does not exist');
                }
            }
        }

        function updateExpiryDate() {
            const prodDate = safeQuerySelector('#prod-date')?.value;
            const expiryEl = safeQuerySelector('#expiry-date');
            
            if (prodDate && expiryEl) {
                const date = new Date(prodDate);
                date.setDate(date.getDate() + 365);
                const expiryText = date.toLocaleDateString('uk-UA');
                expiryEl.textContent = expiryText;
            }
        }

        function clearProductionForm() {
            const form = safeQuerySelector('#production-form');
            if (form) {
                form.reset();
                setupDateFields();
                updateExpiryDate();
                removeQuantityHint();
                
                const warningDiv = safeQuerySelector('#batch-warning');
                if (warningDiv) warningDiv.style.display = 'none';
            }
        }

        function clearWriteoffForm() {
            const form = safeQuerySelector('#writeoff-form');
            if (form) {
                form.reset();
                setupDateFields();
                
                const batchSelect = safeQuerySelector('#wo-batch');
                const batchInfo = safeQuerySelector('#wo-batch-info');
                const availableDiv = safeQuerySelector('#wo-available');
                
                if (batchSelect) batchSelect.style.display = 'none';
                if (batchInfo) batchInfo.style.display = 'none';
                if (availableDiv) availableDiv.textContent = '';
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∞–Ω–Ω—è
        async function loadWriteoffs() {
            const loadingEl = safeQuerySelector('#writeoff-loading');
            const contentEl = safeQuerySelector('#writeoff-content');
            
            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';

                const response = await fetch(`${API_URL}/writeoffs`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∞–Ω–Ω—è');
                
                const result = await response.json();
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
                const writeoffs = result.success ? result.data : result;
                displayWriteoffs(writeoffs);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'block';
            } catch (error) {
                logError('Failed to load writeoffs', 'WRITEOFFS_LOAD_ERROR', error);
                if (loadingEl) loadingEl.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∞–Ω–Ω—è';
            }
        }

        function displayWriteoffs(writeoffs) {
            const tbody = safeQuerySelector('#writeoff-tbody');
            if (!tbody) {
                logError('Writeoffs table body not found', 'DOM_ERROR');
                return;
            }

            tbody.innerHTML = '';

            if (writeoffs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —Å–ø–∏—Å–∞–Ω–Ω—è</td></tr>';
                return;
            }

            writeoffs.forEach(item => {
                const row = document.createElement('tr');
                const writeoffDate = new Date(item.writeoff_date).toLocaleDateString('uk-UA');
                
                // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∞—Ä—Ç—ñ—é - –í–ò–ü–†–ê–í–õ–ï–ù–û –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∞–Ω—å
                const batchInfo = item.batch_date ? 
                    `<span class="batch-status expired">${new Date(item.batch_date).toLocaleDateString('uk-UA')}</span>` : 
                    item.production_date ? 
                    `<span class="batch-status expired">${new Date(item.production_date).toLocaleDateString('uk-UA')}</span>` :
                    '<span style="color: #7f8c8d;">–ó–∞–≥–∞–ª—å–Ω–µ</span>';
                
                row.innerHTML = `
                    <td>${writeoffDate}</td>
                    <td>${item.product_name} (${item.product_code})</td>
                    <td>${batchInfo}</td>
                    <td style="color: #e74c3c; font-weight: bold;">-${item.total_quantity || item.quantity} —à—Ç</td>
                    <td>${item.reason}</td>
                    <td>${item.responsible}</td>
                    <td>${item.notes || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—É—Ö—ñ–≤ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏
        async function loadMovements(filters = {}) {
            const loadingEl = safeQuerySelector('#movements-loading');
            const contentEl = safeQuerySelector('#movements-content');
            
            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentEl) contentEl.style.display = 'none';

                const queryParams = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value) queryParams.append(key, value);
                });

                const response = await fetch(`${API_URL}/movements?${queryParams.toString()}`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—É—Ö—ñ–≤');
                
                const result = await response.json();
                // –û–±—Ä–æ–±–ª—è—î–º–æ –Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç API –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ {success: true, data: [...]}
                const movements = result.success ? result.data : (Array.isArray(result) ? result : []);
                displayMovements(movements);
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentEl) contentEl.style.display = 'block';
            } catch (error) {
                logError('Failed to load movements', 'MOVEMENTS_LOAD_ERROR', error);
                if (loadingEl) loadingEl.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä—É—Ö—ñ–≤';
            }
        }

        function displayMovements(movements) {
            const tbody = safeQuerySelector('#movements-tbody');
            if (!tbody) {
                logError('Movements table body not found', 'DOM_ERROR');
                return;
            }

            tbody.innerHTML = '';

            if (movements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #7f8c8d;">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ —Ä—É—Ö—ñ–≤</td></tr>';
                updateMovementsSummary(movements);
                return;
            }

            movements.forEach(movement => {
                const row = document.createElement('tr');
                const date = new Date(movement.created_at).toLocaleString('uk-UA', { timeZone: 'Europe/Kyiv' });
                const typeText = getMovementTypeText(movement.movement_type);
                const typeClass = getMovementTypeClass(movement.movement_type);
                const quantityText = movement.pieces > 0 ? `+${movement.pieces}` : `${movement.pieces}`;
                const cleanReason = cleanReasonText(movement.reason);
                
                // –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–∞—Ä—Ç—ñ—é
                const batchInfo = movement.batch_date ? 
                    `<span class="batch-status active">${movement.batch_date}</span>` : 
                    '<span style="color: #7f8c8d;">-</span>';
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${movement.product_name} (${movement.product_code})</td>
                    <td>${batchInfo}</td>
                    <td><span class="${typeClass}">${typeText}</span></td>
                    <td style="font-weight: bold; color: ${movement.pieces > 0 ? '#27ae60' : '#e74c3c'}">${quantityText} —à—Ç</td>
                    <td>${cleanReason}</td>
                    <td>${movement.user || 'system'}</td>
                `;
                tbody.appendChild(row);
            });

            updateMovementsSummary(movements);
        }

        function updateMovementsSummary(movements) {
            const totalIn = movements.filter(m => m.pieces > 0).reduce((sum, m) => sum + m.pieces, 0);
            const totalOut = movements.filter(m => m.pieces < 0).reduce((sum, m) => sum + Math.abs(m.pieces), 0);
            
            const countEl = safeQuerySelector('#movements-count');
            const inEl = safeQuerySelector('#total-in');
            const outEl = safeQuerySelector('#total-out');
            
            if (countEl) countEl.textContent = movements.length;
            if (inEl) inEl.textContent = `+${totalIn} —à—Ç`;
            if (outEl) outEl.textContent = `-${totalOut} —à—Ç`;
        }

        function applyMovementsFilter() {
            const filters = {
                product_id: safeQuerySelector('#filter-product')?.value,
                movement_type: safeQuerySelector('#filter-type')?.value,
                batch_date: safeQuerySelector('#filter-batch')?.value,
                date_from: safeQuerySelector('#filter-date-from')?.value,
                date_to: safeQuerySelector('#filter-date-to')?.value
            };
            
            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });
            
            loadMovements(filters);
        }

        function clearMovementsFilter() {
            const filterElements = [
                '#filter-product', '#filter-type', '#filter-batch',
                '#filter-date-from', '#filter-date-to'
            ];
            
            filterElements.forEach(selector => {
                const element = safeQuerySelector(selector);
                if (element) element.value = '';
            });
            
            loadMovements();
        }

        function exportMovements() {
            const table = safeQuerySelector('#movements-table');
            if (!table) {
                showUserError('–¢–∞–±–ª–∏—Ü—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
                return;
            }
            
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',');
            }).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `movements_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–∞—Ä—Ç—ñ—è–º–∏
        async function loadBatchesWithFilter() {
    const loadingEl = safeQuerySelector('#batches-loading');
    const contentEl = safeQuerySelector('#batches-content');
    
    try {
        if (loadingEl) loadingEl.style.display = 'block';
        if (contentEl) contentEl.style.display = 'none';

        console.log('üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –ø–∞—Ä—Ç—ñ—ó...');
        const response = await fetch(`${API_URL}/batches/grouped`);
        
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π');
        
        const batchesData = await response.json();
console.log('Raw batches data received:', batchesData.length, 'products');

        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∏ —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è —ñ—Å–Ω—É—î
        const filteredData = typeof applyBatchesFilters === 'function' ? 
            applyBatchesFilters(batchesData) : batchesData;

        console.log('Filtered data:', filteredData.length, 'products');
        displayBatches(filteredData);
                
        if (loadingEl) loadingEl.style.display = 'none';
        if (contentEl) contentEl.style.display = 'block';
    } catch (error) {
        console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π:', error);
        if (loadingEl) loadingEl.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π: ' + error.message;
    }
}

        function displayBatches(productsWithBatches) {
    console.log('=== displayBatches –í–ò–ö–õ–ò–ö–ê–ù–û ===');
    console.log('Products with batches:', productsWithBatches);
    
    const grid = safeQuerySelector('#batches-grid');
    const summary = safeQuerySelector('#batches-summary');
    
    if (!grid) {
        console.error('Batches grid element not found!');
        return;
    }
    
    console.log('Grid element found:', grid);

    // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–æ–≤–∞—Ä–∏ –∑ –∞–∫—Ç–∏–≤–Ω–∏–º–∏ –ø–∞—Ä—Ç—ñ—è–º–∏
    const productsWithActiveBatches = productsWithBatches.filter(product => 
        product.batches && product.batches.some(batch => batch.available_quantity > 0)
    );

    // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥—Å—É–º–æ–∫
    const totalBatches = productsWithActiveBatches.reduce((sum, p) => {
        const activeBatches = p.batches.filter(b => b.available_quantity > 0);
        return sum + activeBatches.length;
    }, 0);
    
    const totalQuantity = productsWithActiveBatches.reduce((sum, p) => sum + (p.available_quantity || 0), 0);
    
    console.log('Total active batches:', totalBatches);
    console.log('Total quantity:', totalQuantity);
    
    if (summary) {
        const countEl = safeQuerySelector('#batches-total-count');
        const quantityEl = safeQuerySelector('#batches-total-quantity');
        if (countEl) {
            countEl.textContent = totalBatches;
            console.log('Updated total count display');
        }
        if (quantityEl) {
            quantityEl.textContent = totalQuantity;
            console.log('Updated total quantity display');
        }
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ –ø–∞—Ä—Ç—ñ—ó
    if (productsWithActiveBatches.length === 0) {
        grid.innerHTML = `
            <div class="batches-empty" style="grid-column: 1 / -1;">
                <h3>üì¶ –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π</h3>
                <p>–í—Å—ñ –ø–∞—Ä—Ç—ñ—ó –≤–∏—á–µ—Ä–ø–∞–Ω—ñ –∞–±–æ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω—ñ</p>
            </div>
        `;
        return;
    }

    // –ì–µ–Ω–µ—Ä—É—î–º–æ –∫–∞—Ä—Ç–∫–∏ —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏
    const batchesHTML = productsWithActiveBatches.map((product, index) => {
        console.log(`Processing product ${index}:`, product.product_name);
        
        // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –ø–∞—Ä—Ç—ñ—ó
        const activeBatches = product.batches.filter(batch => batch.available_quantity > 0);
        const stockClass = getStockClass(product.stock_status);
        const hasExpiring = activeBatches.some(batch => batch.status === 'EXPIRING');
        
        let cardClass = 'pizza-card';
        if (hasExpiring) cardClass += ' has-expiring';
        
        const batchesListHTML = activeBatches.map(batch => {
            const batchDate = new Date(batch.batch_date || batch.production_date).toLocaleDateString('uk-UA');
            const boxes = Math.floor(batch.available_quantity / product.pieces_per_box);
            const pieces = batch.available_quantity % product.pieces_per_box;
            
            let statusClass = 'active';
            let statusText = '–ê–∫—Ç–∏–≤–Ω–∞';
            
            // –û–±—á–∏—Å–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞—Ç–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è
            if (batch.expiry_date) {
                const expiryDate = new Date(batch.expiry_date);
                const today = new Date();
                const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysToExpiry <= 0) {
                    statusClass = 'expired';
                    statusText = '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∞';
                } else if (daysToExpiry <= 7) {
                    statusClass = 'expiring';
                    statusText = `${daysToExpiry} –¥–Ω.`;
                }
            }
            
            return `
                <div class="batch-item ${statusClass}">
                    <div class="batch-info">
                        <div class="batch-date">${batchDate}</div>
                        <div class="batch-details">
                            <span class="batch-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="batch-quantity">
                        <div class="batch-quantity-main">${batch.available_quantity} —à—Ç</div>
                        <div class="batch-quantity-sub">${boxes} —è—â + ${pieces} —à—Ç</div>
                    </div>
                </div>
            `;
        }).join('');
        
        // –ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ –ø–∞—Ä—Ç—ñ—ó –¥–ª—è —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É
        const activeBatchesCount = activeBatches.length;
        const totalAvailable = activeBatches.reduce((sum, batch) => sum + batch.available_quantity, 0);
        const totalBoxes = Math.floor(totalAvailable / product.pieces_per_box);
        
        return `
            <div class="${cardClass}">
                <div class="stock-indicator ${stockClass}"></div>
                <div class="pizza-name">${product.product_name}</div>
                <div class="pizza-stock ${stockClass}">${totalAvailable} —à—Ç</div>
                <div class="pizza-details">
                    <strong>–ö–æ–¥:</strong> ${product.product_code}<br>
                    <strong>–Ø—â–∏–∫—ñ–≤:</strong> ${totalBoxes}<br>
                    <strong>–ü–∞—Ä—Ç—ñ–π:</strong> ${activeBatchesCount}<br>
                    <strong>–ú—ñ–Ω. –∑–∞–ª–∏—à–æ–∫:</strong> ${product.min_stock_pieces} —à—Ç
                </div>
                <div class="batches-container">
                    <div class="batches-title">–ü–∞—Ä—Ç—ñ—ó —Ç–æ–≤–∞—Ä—É</div>
                    <div class="batches-list">
                        ${batchesListHTML || '<div class="batches-empty">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π</div>'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    console.log('Generated HTML length:', batchesHTML.length);
    grid.innerHTML = batchesHTML;
    console.log('Grid updated with HTML');
    console.log('=== displayBatches –ó–ê–í–ï–†–®–ï–ù–û ===');
}
            function applyBatchesFilters(batchesData) {
                // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
                const productFilter = safeQuerySelector('#batch-filter-product')?.value;
                const statusFilter = safeQuerySelector('#batch-filter-status')?.value;
                const daysFilter = safeQuerySelector('#batch-filter-days')?.value;
                
                console.log('Applying filters:', { productFilter, statusFilter, daysFilter });
                
                // –Ø–∫—â–æ –Ω–µ–º–∞—î —Ñ—ñ–ª—å—Ç—Ä—ñ–≤, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—Å—ñ –¥–∞–Ω—ñ
                if (!productFilter && !statusFilter && !daysFilter) {
                    return batchesData;
                }
                
                let filteredData = [...batchesData];
                
                // –§—ñ–ª—å—Ç—Ä –ø–æ —Ç–æ–≤–∞—Ä—É
                if (productFilter) {
                    filteredData = filteredData.filter(product => 
                        product.product_id == productFilter
                    );
                }
                
                // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ç–∞ –¥–Ω—è—Ö
                if (statusFilter || daysFilter) {
                    filteredData = filteredData.map(product => {
                        let filteredBatches = [...(product.batches || [])];
                        
                        // –§—ñ–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
                        if (statusFilter) {
                            switch (statusFilter) {
                                case 'ACTIVE':
                                    filteredBatches = filteredBatches.filter(batch => 
                                        batch.available_quantity > 0 && 
                                        batch.status !== 'EXPIRED' && 
                                        batch.status !== 'EXPIRING'
                                    );
                                    break;
                                case 'EXPIRING':
                                    filteredBatches = filteredBatches.filter(batch => 
                                        batch.status === 'EXPIRING' || 
                                        (batch.days_to_expiry <= 7 && batch.days_to_expiry > 0)
                                    );
                                    break;
                                case 'EXPIRED':
                                    filteredBatches = filteredBatches.filter(batch => 
                                        batch.status === 'EXPIRED' || 
                                        batch.days_to_expiry <= 0
                                    );
                                    break;
                                case 'DEPLETED':
                                    filteredBatches = filteredBatches.filter(batch => 
                                        batch.available_quantity <= 0
                                    );
                                    break;
                            }
                        }
                        
                        // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–Ω—è—Ö
                        if (daysFilter) {
                            const daysLimit = parseInt(daysFilter);
                            filteredBatches = filteredBatches.filter(batch => 
                                batch.days_to_expiry <= daysLimit && batch.days_to_expiry >= 0
                            );
                        }
                        
                        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ç–æ–≤–∞—Ä —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —î –ø–∞—Ä—Ç—ñ—ó
                        if (filteredBatches.length > 0) {
                            return {
                                ...product,
                                batches: filteredBatches,
                                batches_count: filteredBatches.length,
                                total_available: filteredBatches.reduce((sum, b) => sum + (b.available_quantity || 0), 0)
                            };
                        }
                        return null;
                    }).filter(product => product !== null);
                }
                
                return filteredData;
            }

        async function loadExpiringBatches() {
            try {
                const response = await fetch(`${API_URL}/batches/expiring?days=7`);
                if (!response.ok) throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π —â–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è');
                
                const expiringBatches = await response.json();
                
                if (expiringBatches.length === 0) {
                    showUserError('–ù–µ–º–∞—î –ø–∞—Ä—Ç—ñ–π —â–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º', 'success');
                    return;
                }
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
                const message = `–ó–Ω–∞–π–¥–µ–Ω–æ ${expiringBatches.length} –ø–∞—Ä—Ç—ñ–π —â–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è –ø—Ä–æ—Ç—è–≥–æ–º 7 –¥–Ω—ñ–≤!`;
                showUserError(message, 'warning');
                
                // –ì—Ä—É–ø—É—î–º–æ –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const groupedBatches = {};
                expiringBatches.forEach(batch => {
                    if (!groupedBatches[batch.product_id]) {
                        groupedBatches[batch.product_id] = {
                            product_id: batch.product_id,
                            product_name: batch.product_name,
                            product_code: batch.product_code,
                            pieces_per_box: batch.pieces_per_box,
                            batches: []
                        };
                    }
                    groupedBatches[batch.product_id].batches.push(batch);
                });
                
                const groupedArray = Object.values(groupedBatches);
                displayBatches(groupedArray);
                
            } catch (error) {
                logError('Failed to load expiring batches', 'EXPIRING_BATCHES_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π —â–æ –∑–∞–∫—ñ–Ω—á—É—é—Ç—å—Å—è: ' + error.message);
            }
        }

        function clearBatchesFilter() {
            const filterElements = [
                '#batch-filter-product', '#batch-filter-status', '#batch-filter-days'
            ];
            
            filterElements.forEach(selector => {
                const element = safeQuerySelector(selector);
                if (element) element.value = '';
            });
            
            loadBatchesWithFilter();
        }

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function cleanReasonText(reason) {
            if (!reason) return '-';
            
            if (reason.startsWith('–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ –ø–∞—Ä—Ç—ñ—ó')) {
                return '–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ';
            }
            
            if (reason.startsWith('–°–ø–∏—Å–∞–Ω–Ω—è –ø–∞—Ä—Ç—ñ—ó')) {
                const colonIndex = reason.indexOf(': ');
                if (colonIndex > -1) {
                    return reason.substring(colonIndex + 2);
                }
                return '–°–ø–∏—Å–∞–Ω–Ω—è';
            }
            
            return reason;
        }

        function getMovementTypeText(type) {
            const typeMap = {
                'PRODUCTION': '–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ',
                'WRITEOFF': '–°–ø–∏—Å–∞–Ω–Ω—è',
                'ADJUSTMENT': '–ö–æ—Ä–µ–≥—É–≤–∞–Ω–Ω—è',
                'IN': '–ü—Ä–∏—Ö—ñ–¥',
                'OUT': '–í–∏—Ç—Ä–∞—Ç–∞'
            };
            return typeMap[type] || type;
        }

        function getMovementTypeClass(type) {
            const classMap = {
                'PRODUCTION': 'stock-good',
                'WRITEOFF': 'stock-danger',
                'ADJUSTMENT': 'stock-warning',
                'IN': 'stock-good',
                'OUT': 'stock-danger'
            };
            return classMap[type] || '';
        }

        function getStockClass(stockStatus) {
            return `stock-${stockStatus}`;
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.clearProductionForm = clearProductionForm;
        window.clearWriteoffForm = clearWriteoffForm;
        window.applyMovementsFilter = applyMovementsFilter;
        window.clearMovementsFilter = clearMovementsFilter;
        window.exportMovements = exportMovements;
        window.loadBatchesWithFilter = loadBatchesWithFilter;
        window.clearBatchesFilter = clearBatchesFilter;
        window.loadExpiringBatches = loadExpiringBatches;

        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.refreshPageContent = async function() {
            try {
                const activeTab = safeQuerySelector('.tab.active');
                if (!activeTab) return;
                
                const tabText = activeTab.textContent || '';
                
                if (tabText.includes('–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ')) {
                    await Promise.all([loadProduction(), loadStats()]);
                } else if (tabText.includes('–°–ø–∏—Å–∞–Ω–Ω—è')) {
                    await Promise.all([loadWriteoffs(), loadStats()]);
                } else if (tabText.includes('–Ü—Å—Ç–æ—Ä—ñ—è')) {
                    await loadMovements();
                } else if (tabText.includes('–ü–∞—Ä—Ç—ñ—ó')) {
                    await loadBatchesWithFilter();
                }
            } catch (error) {
                logError('Failed to refresh page content', 'REFRESH_ERROR', error);
                showUserError('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö');
            }
        };

        // –î–æ–¥–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('focus', function() {
            if (typeof window.refreshPageContent === 'function') {
                window.refreshPageContent();
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –≤–∫–ª–∞–¥–æ–∫
        window._tabHandlers = {};
        window.setTabHandler = function(tab, fn) {
            window._tabHandlers[tab] = fn;
        };
        window._tabHandlers = window._tabHandlers || {};
        window._tabHandlers['batches'] = function() {
        loadBatchesWithFilter();
};
        function populateBatchProductFilter() {
            const productFilter = safeQuerySelector('#batch-filter-product');
            if (!productFilter || !products || products.length === 0) {
                return;
            }
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
            const currentValue = productFilter.value;
            
            // –û—á–∏—â—É—î–º–æ –æ–ø—Ü—ñ—ó (–∫—Ä—ñ–º –ø–µ—Ä—à–æ—ó "–í—Å—ñ —Ç–æ–≤–∞—Ä–∏")
            while (productFilter.children.length > 1) {
                productFilter.removeChild(productFilter.lastChild);
            }
            
            // –î–æ–¥–∞—î–º–æ —Ç–æ–≤–∞—Ä–∏
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.code})`;
                productFilter.appendChild(option);
            });
            
            // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è
            productFilter.value = currentValue;
            
            console.log('–ü–æ–ø—É–ª—è—Ü—ñ—è —Ñ—ñ–ª—å—Ç—Ä—É —Ç–æ–≤–∞—Ä—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', products.length, '—Ç–æ–≤–∞—Ä—ñ–≤');
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Inventory System</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    
    <style>
        .welcome-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .welcome-card h1 {
            font-size: 2.5em;
            margin-bottom: 1rem;
        }
        
        .welcome-card p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .pizzas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        
        .pizza-card {
            background: white;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .pizza-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        
        .pizza-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .pizza-stock {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .pizza-details {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .last-update {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
            font-style: italic;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .pizzas-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –ø–∞—Ä—Ç—ñ–π */
        .pizza-card.has-expiring {
            border-color: #f39c12;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
        }
        
        .pizza-card.has-expired {
            border-color: #e74c3c;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }
        
        @media (max-width: 768px) {
            .welcome-card h1 {
                font-size: 2em;
            }
            
            .welcome-card p {
                font-size: 1em;
            }
            
            .pizzas-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="welcome-card">
            <h1>üçï –°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ—ó –ø—ñ—Ü–∏</h1>
            <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–ø–∞—Å–∞–º–∏, –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ–º —Ç–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è–º–∏ –∑ –ø–∞—Ä—Ç—ñ–π–Ω–∏–º –æ–±–ª—ñ–∫–æ–º</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-pizzas">0</div>
                <div class="stat-label">–í–∏–¥—ñ–≤ –ø—ñ—Ü–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-stock">0</div>
                <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å (—à—Ç)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-boxes">0</div>
                <div class="stat-label">–ó–∞–≥–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å (—è—â)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-batches">0</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π</div>
            </div>
        </div>

        <div class="pizzas-section">
            <div class="section-header">
                <h2>üìä –ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ø–∞—Å–∏ —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏</h2>
                <button class="refresh-btn" onclick="refreshPage()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
            </div>
            
            <div id="content">
                <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
            </div>

            <div class="last-update">
                –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <span id="last-update-time">-</span>
            </div>
        </div>
    </div>

    <script src="/js/error-handler.js"></script>
    <script src="/js/navigation.js"></script>
    
    <script>
        const API_URL = '/api';

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ DOM
        document.addEventListener('DOMContentLoaded', function() {
            loadPizzasWithBatches();
        });

        async function loadPizzasWithBatches() {
            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–æ–≤–∞—Ä–∏ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏
                const batchesResponse = await fetch(`${API_URL}/batches/grouped`);
                
                if (!batchesResponse.ok) {
                    throw new Error(`HTTP error! status: ${batchesResponse.status}`);
                }
                
                const productsWithBatches = await batchesResponse.json();
                displayPizzasWithBatches(productsWithBatches);
                updateStatsWithBatches(productsWithBatches);
                updateLastUpdateTime();
                
            } catch (error) {
                logError('Failed to load pizzas with batches data', 'DATA_LOAD_ERROR', error);
                
                const content = safeQuerySelector('#content');
                if (content) {
                    content.innerHTML = `
                        <div class="error">
                            ‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ
                            <br>–ü–æ–º–∏–ª–∫–∞: ${error.message}
                            <br><button class="refresh-btn" onclick="loadPizzasWithBatches()" style="margin-top: 1rem;">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                        </div>
                    `;
                }
                
                showUserError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤');
            }
        }

        function displayPizzasWithBatches(products) {
            const content = safeQuerySelector('#content');
            if (!content) {
                logError('Content element not found', 'DOM_ERROR');
                return;
            }
            
            if (products.length === 0) {
                content.innerHTML = '<div class="loading">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ç–æ–≤–∞—Ä–∏ –∑ –ø–∞—Ä—Ç—ñ—è–º–∏</div>';
                return;
            }

            const pizzasHTML = products.map(product => {
                const stockClass = getStockClass(product.stock_status);
                const hasExpiring = product.expiring_quantity > 0;
                const hasExpired = product.batches.some(b => b.status === 'EXPIRED');
                
                let cardClass = 'pizza-card';
                if (hasExpired) cardClass += ' has-expired';
                else if (hasExpiring) cardClass += ' has-expiring';
                
                // –ì–µ–Ω–µ—Ä—É—î–º–æ HTML –¥–ª—è –ø–∞—Ä—Ç—ñ–π
                const batchesHTML = generateBatchesHTML(product.batches, product.pieces_per_box, product.product_id);
                
                // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —Ç–µ—Ä–º—ñ–Ω–∏
                let expiryWarning = '';
                if (hasExpired) {
                    const expiredBatches = product.batches.filter(b => b.status === 'EXPIRED').length;
                    expiryWarning = `<div class="expiry-warning critical">‚ö†Ô∏è ${expiredBatches} –ø–∞—Ä—Ç—ñ–π –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ!</div>`;
                } else if (hasExpiring) {
                    const expiringBatches = product.batches.filter(b => b.status === 'EXPIRING').length;
                    expiryWarning = `<div class="expiry-warning">‚è∞ ${expiringBatches} –ø–∞—Ä—Ç—ñ–π –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —Ç–µ—Ä–º—ñ–Ω!</div>`;
                }
                
                return `
                    <div class="${cardClass}">
                        <div class="pizza-name">${product.product_name}</div>
                        <div class="pizza-stock ${stockClass}">${product.total_available || 0} —à—Ç</div>
                        <div class="pizza-details">
                            –ö–æ–¥: ${product.product_code}<br>
                            –Ø—â–∏–∫—ñ–≤: ${product.total_boxes || 0}<br>
                            –ü–∞—Ä—Ç—ñ–π: <strong>${product.batches_count || 0}</strong>
                        </div>
                        ${expiryWarning}
                        ${batchesHTML}
                    </div>
                `;
            }).join('');

            content.innerHTML = `<div class="pizzas-grid">${pizzasHTML}</div>`;
            
            // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø–∞—Ä—Ç—ñ–π –∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é
            setTimeout(() => {
                setupBatchesToggles();
            }, 100);
        }

        function generateBatchesHTML(batches, piecesPerBox, productId) {
            if (!batches || batches.length === 0) {
                return `
                    <div class="batches-container">
                        <div class="batches-empty">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–∞—Ä—Ç—ñ–π</div>
                    </div>
                `;
            }
            
            // –°–æ—Ä—Ç—É—î–º–æ –ø–∞—Ä—Ç—ñ—ó –ø–æ –¥–∞—Ç—ñ (–Ω–∞–π—Å—Ç–∞—Ä—ñ—à—ñ —Å–ø–æ—á–∞—Ç–∫—É)
            const sortedBatches = batches.sort((a, b) => new Date(a.batch_date) - new Date(b.batch_date));
            
            const batchesListHTML = sortedBatches.map(batch => {
                const boxes = Math.floor(batch.available_quantity / piecesPerBox);
                const pieces = batch.available_quantity % piecesPerBox;
                const batchDate = new Date(batch.batch_date).toLocaleDateString('uk-UA');
                const expiryDate = new Date(batch.expiry_date).toLocaleDateString('uk-UA');
                
                let statusClass = 'active';
                let statusText = '–ê–∫—Ç–∏–≤–Ω–∞';
                
                if (batch.status === 'EXPIRED') {
                    statusClass = 'expired';
                    statusText = '–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∞';
                } else if (batch.status === 'EXPIRING') {
                    statusClass = 'expiring';
                    statusText = `${batch.days_to_expiry} –¥–Ω. –¥–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è`;
                } else if (batch.available_quantity <= 0) {
                    statusClass = 'depleted';
                    statusText = '–í–∏—á–µ—Ä–ø–∞–Ω–∞';
                }
                
                return `
                    <div class="batch-item ${statusClass}">
                        <div class="batch-info">
                            <div class="batch-date">${batchDate}</div>
                            <div class="batch-details">
                                <span>–¢–µ—Ä–º—ñ–Ω –¥–æ: ${expiryDate}</span>
                                <span class="batch-status ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        <div class="batch-quantity">
                            <div class="batch-quantity-main">${batch.available_quantity} —à—Ç</div>
                            <div class="batch-quantity-sub">${boxes} —è—â + ${pieces} —à—Ç</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const oldestBatch = sortedBatches[0];
            const oldestDate = new Date(oldestBatch.batch_date).toLocaleDateString('uk-UA');
            const uniqueId = `batches-${productId}`; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ productId –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
            
            return `
                <div class="batches-container">
                    <div class="batches-header">
                        <div class="batches-title">üì¶ –ü–∞—Ä—Ç—ñ—ó</div>
                        <button class="batches-toggle" data-target="${uniqueId}">
                            –ü–æ–∫–∞–∑–∞—Ç–∏
                        </button>
                    </div>
                    <div class="batches-summary">
                        <span class="batches-count">${batches.length} –ø–∞—Ä—Ç—ñ–π</span>
                        <span class="batches-oldest">–Ω–∞–π—Å—Ç–∞—Ä—ñ—à–∞: ${oldestDate}</span>
                    </div>
                    <div class="batches-list" id="${uniqueId}">
                        ${batchesListHTML}
                    </div>
                </div>
            `;
        }

        function setupBatchesToggles() {
            const toggles = document.querySelectorAll('.batches-toggle');
            console.log('–ó–Ω–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è:', toggles.length); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            
            toggles.forEach((toggle, index) => {
                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ (—è–∫—â–æ —î)
                toggle.replaceWith(toggle.cloneNode(true));
                const newToggle = document.querySelectorAll('.batches-toggle')[index];
                
                newToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('–ö–Ω–æ–ø–∫–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞:', this); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    
                    const targetId = this.getAttribute('data-target');
                    const batchesList = document.getElementById(targetId);
                    
                    console.log('Target ID:', targetId, 'Element:', batchesList); // –î–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    
                    if (batchesList) {
                        const isExpanded = batchesList.classList.contains('expanded');
                        
                        if (isExpanded) {
                            batchesList.classList.remove('expanded');
                            this.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏';
                        } else {
                            batchesList.classList.add('expanded');
                            this.textContent = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏';
                        }
                    } else {
                        console.error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç –∑ ID:', targetId);
                    }
                });
            });
        }

        function getStockClass(stockStatus) {
            return `stock-${stockStatus}`;
        }

        function updateStatsWithBatches(products) {
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => sum + (p.total_available || 0), 0);
            const totalBoxes = products.reduce((sum, p) => sum + (p.total_boxes || 0), 0);
            const totalBatches = products.reduce((sum, p) => sum + (p.batches_count || 0), 0);

            const elements = {
                'total-pizzas': totalProducts,
                'total-stock': totalStock, 
                'total-boxes': totalBoxes,
                'total-batches': totalBatches
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = safeQuerySelector(`#${id}`);
                if (element) {
                    element.textContent = value;
                } else {
                    logError(`Stats element not found: ${id}`, 'DOM_ERROR');
                }
            });
        }

        function updateLastUpdateTime() {
            const timeElement = safeQuerySelector('#last-update-time');
            if (timeElement) {
                const now = new Date();
                const timeString = now.toLocaleString('uk-UA');
                timeElement.textContent = timeString;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            try {
                loadPizzasWithBatches();
            } catch (error) {
                logError('Auto refresh failed', 'AUTO_REFRESH_ERROR', error);
            }
        }, 30000);
        
        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.refreshPageContent = function() {
            loadPizzasWithBatches();
        };

        // –î–æ–¥–∞—î–º–æ –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('focus', function() {
            if (typeof window.refreshPageContent === 'function') {
                window.refreshPageContent();
            }
        });
    </script>
</body>
</html>